<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mading Komunitas - Cendekia Aksara</title>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap');
        :root { --primary: #003366; --secondary: #005a9c; --accent: #f0f4f8; }
        body { font-family: 'Poppins', sans-serif; background-color: var(--accent); margin: 0; color: #333; }
        .container { max-width: 900px; margin: 20px auto; padding: 20px; }
        .hidden { display: none !important; }
        .btn { padding: 10px 20px; border: none; border-radius: 8px; color: #fff; background-color: var(--secondary); font-weight: 600; cursor: pointer; transition: background-color 0.2s; }
        .btn:disabled { background-color: #999; cursor: not-allowed; }
        .btn-danger { background-color: #dc3545; }
        .btn-secondary { background-color: #6c757d; }
        .card { background: #fff; padding: 30px; border-radius: 12px; box-shadow: 0 8px 30px rgba(0,0,0,0.1); }
        .form-group { margin-bottom: 20px; }
        .form-group label { display: block; font-weight: 600; margin-bottom: 8px; }
        .form-group input, .form-group textarea { width: 100%; padding: 12px; border: 1px solid #ccc; border-radius: 8px; box-sizing: border-box; font-size: 1em; }
        .header { display: flex; justify-content: space-between; align-items: center; background: #fff; padding: 15px 30px; border-radius: 12px; box-shadow: 0 4px 20px rgba(0,0,0,0.08); }
        .profile-bubble { width: 40px; height: 40px; border-radius: 50%; background-color: var(--primary); color: white; display: flex; justify-content: center; align-items: center; font-weight: bold; cursor: pointer; background-size: cover; background-position: center; flex-shrink: 0; }
        .mading-wall { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 20px; margin-top: 30px; }
        .post-card { position: relative; background: #fff; padding: 20px; border-radius: 12px; box-shadow: 0 4px 20px rgba(0,0,0,0.06); animation: fadeIn 0.5s; display: flex; flex-direction: column; }
        .post-card-clickable { flex-grow: 1; cursor: pointer; }
        .post-card h3 { margin: 0 0 10px; color: var(--primary); }
        .post-card .meta { font-size: 0.8em; color: #6c757d; margin-bottom: 15px; }
        .post-card p { margin: 0; white-space: pre-wrap; line-height: 1.7; display: -webkit-box; -webkit-line-clamp: 4; -webkit-box-orient: vertical; overflow: hidden; }
        .post-card .author { font-size: 0.9em; margin-top: 15px; color: #6c757d; font-weight: 500; }
        .author-link { color: var(--secondary); text-decoration: none; font-weight: 600; cursor: pointer; }
        .author-link:hover { text-decoration: underline; }
        .post-actions { border-top: 1px solid #eee; margin-top: 15px; padding-top: 10px; font-size: 0.9em; color: #6c757d; display: flex; gap: 15px; }
        .modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.6); display: flex; justify-content: center; align-items: center; z-index: 1000; }
        .modal-content { background: #fff; padding: 30px; border-radius: 12px; box-shadow: 0 8px 30px rgba(0,0,0,0.1); width: 90%; max-width: 500px; animation: fadeIn 0.3s; }
        .profile-header { display: flex; flex-direction: column; align-items: center; gap: 20px; margin-bottom: 20px; text-align:center; }
        .profile-pic-large { width: 100px; height: 100px; border-radius: 50%; background-color: var(--primary); color: white; display: flex; justify-content: center; align-items: center; font-weight: bold; font-size: 3em; background-size: cover; background-position: center; position: relative; border: 4px solid white; box-shadow: 0 4px 15px rgba(0,0,0,0.2);}
        .profile-stats { display: flex; gap: 20px; justify-content: center; }
        .verified-badge { width: 24px; height: 24px; color: var(--secondary); }
        .back-btn { background: none; border: none; font-weight: 600; color: var(--secondary); cursor: pointer; font-size: 1em; margin-bottom: 20px; display:flex; align-items:center; gap: 5px; }
        .fab { position: fixed; width: 50px; height: 50px; border-radius: 50%; border: none; color: white; font-size: 24px; cursor: pointer; box-shadow: 0 4px 15px rgba(0,0,0,0.3); display: flex; justify-content: center; align-items: center; z-index: 50;}
        #help-btn { bottom: 30px; left: 30px; background-color: #25D366; }
        #loading-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(255, 255, 255, 0.85); display: flex; flex-direction: column; justify-content: center; align-items: center; z-index: 9999; }
        .progress-spinner { width: 60px; height: 60px; border-radius: 50%; border: 4px solid #e3e9ef; border-top-color: var(--secondary); animation: spin 1s linear infinite; }
        #loading-overlay p { margin-top: 20px; font-size: 1.2em; font-weight: 600; color: var(--primary); }
        .post-menu { position: absolute; top: 15px; right: 15px; }
        .post-menu-btn { background:none; border:none; cursor:pointer; font-size:20px; color:#aaa; padding: 5px;}
        .dropdown-menu { display:none; position:absolute; right:0; top:25px; background:white; border-radius:8px; box-shadow:0 2px 10px rgba(0,0,0,0.2); z-index:10; overflow: hidden;}
        .dropdown-menu a { display:block; padding:8px 15px; color:#333; text-decoration:none; font-size:14px; }
        .dropdown-menu a:hover { background-color:#f0f4f8; }
        
        /* Search */
        #search-btn { background: none; border: none; cursor: pointer; color: #6c757d; padding: 5px; }
        .search-result-item { padding: 10px; border-bottom: 1px solid #eee; cursor: pointer; }
        .search-result-item:hover { background-color: #f0f4f8; }
        
        /* Detail Page Styles */
        .like-btn { padding: 8px 15px; border-radius: 20px; border: 1px solid #ccc; background-color: #f0f4f8; cursor: pointer; transition: all 0.2s; }
        .like-btn.liked { background-color: #e3f2fd; border-color: var(--secondary); color: var(--secondary); font-weight: 600; }
        .comment-section { margin-top: 30px; }
        .comment-list { list-style-type: none; padding: 0; margin-top: 20px; }
        .comment-item { position: relative; background-color: var(--accent); padding: 15px; border-radius: 8px; margin-bottom: 10px; }
        .comment-item strong { color: var(--primary); }
        .comment-item p { margin: 5px 0 0; }
        
        @keyframes spin { to { transform: rotate(360deg); } }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        
        @media (max-width: 600px) {
            body { background-color: #fff; }
            .container { margin: 0 auto; padding: 10px; }
            .card { box-shadow: none; border-radius: 0; padding: 20px 15px; }
            .header { flex-direction: column; gap: 15px; align-items: stretch; border-radius: 0; }
            .header-welcome-info { flex-grow: 1; }
            .header-actions { justify-content: flex-end; width: 100%; }
            #show-post-modal-btn { flex-grow: 1; text-align: center; }
            .header h2 { font-size: 1.2em; word-break: break-word; }
        }
    </style>
</head>
<body>
    <div id="auth-container" class="container card" style="max-width: 400px; margin-top: 5vh;">
        <div id="login-view"><h1>Masuk ke Mading</h1><form id="login-form"><div class="form-group"><label for="login-email">Email</label><input type="email" id="login-email" required></div><div class="form-group"><label for="login-password">Password</label><input type="password" id="login-password" required></div><button type="submit" class="btn" style="width:100%;">Login</button><p style="text-align: center; margin-top: 15px; cursor: pointer; color: #005a9c;" id="show-register">Belum punya akun? Daftar di sini.</p></form></div>
        <div id="register-view" class="hidden"><h1>Daftar Akun Baru</h1><form id="register-form"><div class="form-group"><label for="register-name">Nama Lengkap / Pena</label><input type="text" id="register-name" required></div><div class="form-group"><label for="register-email">Email</label><input type="email" id="register-email" required></div><div class="form-group"><label for="register-password">Password</label><input type="password" id="register-password" required></div><button type="submit" class="btn" style="width:100%;">Daftar</button><p style="text-align: center; margin-top: 15px; cursor: pointer; color: #005a9c;" id="show-login">Sudah punya akun? Masuk.</p></form></div>
    </div>
    
    <div id="app-container" class="container hidden"></div>
    <div id="modal-container"></div>
    <a href="https://wa.me/628895615630" target="_blank" id="help-btn" class="fab" title="Butuh Bantuan?"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24" fill="currentColor"><path d="M.057 24l1.687-6.163c-1.041-1.804-1.588-3.849-1.587-5.946.003-6.556 5.338-11.891 11.893-11.891 3.181.001 6.167 1.24 8.413 3.488 2.245 2.248 3.487 5.235 3.487 8.413.003 6.557-5.338 11.892-11.894 11.892-1.99-.001-3.951-.5-5.688-1.448l-6.305 1.654zm6.597-3.807c1.676.995 3.276 1.591 5.392 1.592 5.448 0 9.886-4.434 9.889-9.885.002-5.462-4.433-9.89-9.889-9.89-5.452 0-9.887 4.434-9.889 9.89.001 2.23 1.056 4.411 2.899 6.001l.111.129-.755 2.726 2.735-.74z"/></svg></a>
    <div id="loading-overlay" class="hidden"><div class="progress-spinner"></div><p id="loading-text">Memuat...</p></div>

<script>
    const firebaseConfig = { apiKey: "AIzaSyDpUWUIzPXIZN6rrNtsIqcL6VfOE2RLVl0", authDomain: "mading-cf676.firebaseapp.com", projectId: "mading-cf676", storageBucket: "mading-cf676.firebasestorage.app", messagingSenderId: "72175203671", appId: "1:72175203671:web:7a0676a55beb64bc96ba12" };

    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();

    const authContainer = document.getElementById('auth-container');
    const appContainer = document.getElementById('app-container');
    const modalContainer = document.getElementById('modal-container');
    const loadingOverlay = document.getElementById('loading-overlay');
    const loadingText = document.getElementById('loading-text');
    
    let stopPostsListener = null;
    let stopViewListener = null;
    let currentUserData = null;

    function showLoading(message) { loadingText.textContent = message; loadingOverlay.classList.remove('hidden'); }
    function hideLoading() { loadingOverlay.classList.add('hidden'); }
    
    document.getElementById('show-register').onclick = () => { document.getElementById('login-view').classList.add('hidden'); document.getElementById('register-view').classList.remove('hidden'); };
    document.getElementById('show-login').onclick = () => { document.getElementById('register-view').classList.add('hidden'); document.getElementById('login-view').classList.remove('hidden'); };
    
    function renderModal(title, message, buttons) {
        const buttonsHTML = buttons.map(btn => `<button class="btn ${btn.className || ''}" id="${btn.id}">${btn.text}</button>`).join('');
        modalContainer.innerHTML = `<div class="modal"><div class="modal-content"><h2>${title}</h2><p>${message}</p><div style="display:flex; gap:10px; justify-content: flex-end; margin-top:20px;">${buttonsHTML}</div></div></div>`;
    }

    function showCustomAlert(message, title = 'Informasi') {
        renderModal(title, message, [{id: 'modal-ok-btn', text: 'OK', className: 'btn-secondary'}]);
        document.getElementById('modal-ok-btn').onclick = () => { modalContainer.innerHTML = ''; };
    }

    function showCustomConfirm(message, title = 'Konfirmasi') {
        return new Promise(resolve => {
            renderModal(title, message, [{id: 'modal-cancel-btn', text: 'Batal', className: 'btn-secondary'}, {id: 'modal-confirm-btn', text: 'Hapus', className: 'btn-danger'}]);
            document.getElementById('modal-confirm-btn').onclick = () => { modalContainer.innerHTML = ''; resolve(true); };
            document.getElementById('modal-cancel-btn').onclick = () => { modalContainer.innerHTML = ''; resolve(false); };
        });
    }

    function cleanupListeners() {
        if (stopPostsListener) { stopPostsListener(); stopPostsListener = null; }
        if (stopViewListener) { stopViewListener(); stopViewListener = null; }
    }

    auth.onAuthStateChanged(user => {
        showLoading('Mengecek sesi...');
        cleanupListeners();
        if (user) {
            db.collection("users").doc(user.uid).onSnapshot(doc => {
                if(doc.exists) {
                    const wasNull = currentUserData === null;
                    currentUserData = { uid: user.uid, ...doc.data() };
                    if (wasNull || !document.getElementById('mading-view')) {
                         renderDashboard();
                    }
                    hideLoading();
                } else { auth.signOut(); }
            }, err => { console.error(err); auth.signOut(); hideLoading(); });
        } else {
            currentUserData = null;
            authContainer.classList.remove('hidden');
            appContainer.classList.add('hidden');
            hideLoading();
        }
    });

    function renderDashboard() {
        cleanupListeners();
        authContainer.classList.add('hidden');
        appContainer.classList.remove('hidden');
        appContainer.innerHTML = `
            <div id="mading-view">
                <div class="header">
                    <div style="display:flex; align-items:center; gap:15px;">
                        <div id="profile-bubble" class="profile-bubble" title="Lihat Profil Saya">${currentUserData.name.charAt(0).toUpperCase()}</div>
                        <div class="header-welcome-info">
                            <h2 style="text-align:left; margin:0;">Selamat Datang, ${currentUserData.name}!</h2>
                            <button id="logout-btn" class="btn-danger" style="padding: 4px 8px; font-size: 12px; border-radius: 6px;">Logout</button>
                        </div>
                    </div>
                    <div class="header-actions" style="display:flex; align-items:center; gap:10px;">
                        <button id="search-btn" title="Cari">
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="currentColor"><path d="M15.5 14h-.79l-.28-.27A6.471 6.471 0 0 0 16 9.5 6.5 6.5 0 1 0 9.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79l5 4.99L20.49 19l-4.99-5zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14z"/></svg>
                        </button>
                        <button id="show-post-modal-btn" class="btn">Kirim Karya Baru +</button>
                    </div>
                </div>
                <div id="mading-wall" class="mading-wall"></div>
            </div>`;
        document.getElementById('profile-bubble').onclick = () => renderProfilePage(currentUserData.uid);
        document.getElementById('logout-btn').onclick = () => auth.signOut();
        document.getElementById('show-post-modal-btn').onclick = () => renderPostModal('create');
        document.getElementById('search-btn').onclick = renderSearchView;
        fetchAndRenderPosts();
    }

    function fetchAndRenderPosts() {
        if (stopPostsListener) { stopPostsListener(); stopPostsListener = null; }
        const madingWall = document.getElementById('mading-wall');
        if (!madingWall) return;
        madingWall.innerHTML = '<p>Memuat beranda...</p>';
        
        stopPostsListener = db.collection("posts").orderBy("timestamp", "desc").onSnapshot(querySnapshot => {
            if (!document.getElementById('mading-wall')) return;
            const allPosts = querySnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            const following = currentUserData.following || [];
            
            madingWall.innerHTML = '';
            if (following.length === 0) {
                renderPosts(allPosts);
            } else {
                const followedPosts = allPosts.filter(p => following.includes(p.authorId));
                const topFollowedPosts = followedPosts.slice(0, 2);
                const followedPostIds = new Set(topFollowedPosts.map(p => p.id));
                const filteredPublicPosts = allPosts.filter(p => !followedPostIds.has(p.id));

                if (topFollowedPosts.length > 0) {
                    const followedHeader = document.createElement('div');
                    followedHeader.style.gridColumn = '1 / -1';
                    followedHeader.innerHTML = `<h2 style="font-size: 1.5em; color: var(--primary); margin-bottom: 0;">Karya dari yang Anda ikuti</h2>`;
                    madingWall.appendChild(followedHeader);
                    renderPosts(topFollowedPosts, true);
                }

                const publicHeader = document.createElement('div');
                publicHeader.style.gridColumn = '1 / -1';
                publicHeader.style.marginTop = topFollowedPosts.length > 0 ? '40px' : '0';
                publicHeader.innerHTML = `<h2 style="font-size: 1.5em; color: var(--primary); margin-bottom: 0;">Jelajahi Karya Lain</h2>`;
                madingWall.appendChild(publicHeader);
                
                if (filteredPublicPosts.length > 0) {
                    renderPosts(filteredPublicPosts, true);
                } else {
                    madingWall.innerHTML += '<p>Tidak ada karya lain untuk dijelajahi saat ini.</p>';
                }
            }
        }, error => {
            console.error("Gagal memuat beranda:", error);
            if (madingWall) madingWall.innerHTML = '<p>Gagal memuat karya.</p>';
        });
    }
    
    function renderPosts(posts, append = false) {
        const wallId = document.getElementById('profile-wall') ? 'profile-wall' : 'mading-wall';
        const wall = document.getElementById(wallId);
        if(!wall) return;
        if (!append) wall.innerHTML = '';
        if (posts.length === 0 && !append) {
            wall.innerHTML = '<p>Belum ada karya yang dikirim.</p>';
            return;
        }

        posts.forEach(post => {
            const postCard = document.createElement('div');
            postCard.className = 'post-card';
            const postDate = post.timestamp ? post.timestamp.toDate().toLocaleString('id-ID') : 'Baru saja';
            let menuButton = '';
            if (currentUserData && currentUserData.uid === post.authorId) {
                menuButton = `<div class="post-menu"><button class="post-menu-btn" data-menu-id="${post.id}">&#8942;</button><div id="menu-${post.id}" class="dropdown-menu"><a href="#" class="edit-btn" data-post-id="${post.id}">Edit</a><a href="#" class="delete-btn" data-post-id="${post.id}">Hapus</a></div></div>`;
            }
            postCard.innerHTML = `
                ${menuButton}
                <div class="post-card-clickable" data-post-id="${post.id}">
                    <h3>${post.title}</h3>
                    <p class="meta">${postDate}</p>
                    <p>${post.content}</p>
                </div>
                <div class="post-actions">
                    <span>❤️ ${post.likeCount || 0} Suka</span>
                    <span>💬 ${post.commentCount || 0} Komentar</span>
                </div>
                <p class="author">oleh: <a href="#" class="author-link" data-author-id="${post.authorId}">${post.authorName}</a></p>
            `;
            wall.appendChild(postCard);
        });
    }

    function renderPostDetailPage(postId) {
        cleanupListeners();
        showLoading("Memuat karya...");

        stopViewListener = db.collection("posts").doc(postId).onSnapshot(async (postDoc) => {
            if (!document.getElementById('app-container')) return; 
            if (!postDoc.exists) {
                showCustomAlert("Karya tidak ditemukan atau telah dihapus.", "Error");
                renderDashboard();
                return;
            }
            const postData = { id: postDoc.id, ...postDoc.data() };
            
            const commentsSnapshot = await db.collection("comments").where("postId", "==", postId).get();
            let comments = [];
            commentsSnapshot.forEach(doc => comments.push({id: doc.id, ...doc.data()}));
            comments.sort((a, b) => (a.timestamp?.toDate() || 0) - (b.timestamp?.toDate() || 0));

            const isLiked = currentUserData && postData.likes && postData.likes.includes(currentUserData.uid);
            
            appContainer.innerHTML = `
                <div id="post-detail-view" class="card" data-post-id="${postData.id}">
                    <button id="back-to-mading-btn" class="back-btn">← Kembali</button>
                    <h1>${postData.title}</h1>
                    <p class="meta">oleh <a href="#" class="author-link" data-author-id="${postData.authorId}">${postData.authorName}</a> pada ${postData.timestamp ? postData.timestamp.toDate().toLocaleString('id-ID') : ''}</p>
                    <p style="white-space: pre-wrap; line-height: 1.8;">${postData.content}</p>
                    <div style="margin-top: 20px; padding-top: 20px; border-top: 1px solid #eee;">
                        <button id="like-btn" class="like-btn ${isLiked ? 'liked' : ''}">
                           ❤️ <span id="like-count">${postData.likeCount || 0}</span> Suka
                        </button>
                    </div>
                    <div class="comment-section">
                        <h3>Komentar (${postData.commentCount || 0})</h3>
                        <form id="comment-form" class="form-group">
                            <textarea id="comment-content" rows="3" placeholder="Tulis komentar Anda..." required></textarea>
                            <button type="submit" class="btn" style="margin-top:10px;">Kirim</button>
                        </form>
                        <ul id="comment-list" class="comment-list"></ul>
                    </div>
                </div>`;

            const commentList = document.getElementById('comment-list');
            commentList.innerHTML = '';
            const commentsByParent = comments.reduce((acc, comment) => {
                const parentId = comment.parentId || 'root';
                if (!acc[parentId]) acc[parentId] = [];
                acc[parentId].push(comment);
                return acc;
            }, {});

            const renderCommentTree = (parentId, container) => {
                if (!commentsByParent[parentId]) return;
                commentsByParent[parentId].forEach(comment => {
                    let menuButton = '';
                    if (currentUserData && currentUserData.uid === comment.authorId) {
                        menuButton = `<div class="post-menu"><button class="post-menu-btn" data-menu-id="comment-${comment.id}">&#8942;</button><div id="menu-comment-${comment.id}" class="dropdown-menu"><a href="#" class="edit-comment-btn" data-comment-id="${comment.id}">Edit</a><a href="#" class="delete-comment-btn" data-comment-id="${comment.id}">Hapus</a></div></div>`;
                    }
                    const li = document.createElement('li');
                    li.className = 'comment-item';
                    li.innerHTML = `
                        ${menuButton}
                        <strong>${comment.authorName}</strong>
                        <p>${comment.content}</p>
                        <div class="reply-btn" data-comment-id="${comment.id}">Balas</div>
                    `;
                    container.appendChild(li);
                    
                    const repliesContainer = document.createElement('div');
                    repliesContainer.className = 'replies-container';
                    li.appendChild(repliesContainer);
                    renderCommentTree(comment.id, repliesContainer);
                });
            };

            if(comments.length > 0) {
                renderCommentTree('root', commentList);
            } else {
                commentList.innerHTML = '<p>Jadilah yang pertama berkomentar!</p>';
            }
            document.getElementById('back-to-mading-btn').onclick = renderDashboard;
            hideLoading();
        }, error => {
            console.error("Gagal membuka detail karya:", error);
            showCustomAlert("Gagal membuka detail karya.", "Error");
            renderDashboard();
        });
    }

    async function renderProfilePage(authorId) {
        cleanupListeners();
        showLoading("Memuat profil...");
        
        stopViewListener = db.collection("users").doc(authorId).onSnapshot(async (userDoc) => {
            if (!document.getElementById('app-container')) return;
            if (!userDoc.exists) {
                 showCustomAlert("Penulis tidak ditemukan.", "Error");
                 renderDashboard();
                 return;
            }

            const userData = userDoc.data();
            
            if (!document.getElementById('profile-view')) {
                appContainer.innerHTML = `<div id="profile-view" class="card" data-author-id="${authorId}"><button id="back-to-mading-btn" class="back-btn">← Kembali</button><div class="profile-header"><div id="profile-pic-large" class="profile-pic-large"></div><div><div style="display:flex;align-items:center;gap:10px;justify-content:center;"><h1 id="profile-name" style="text-align:center;margin:0;"></h1><span id="verified-badge-container"></span></div><div class="profile-stats"><p><strong id="karya-count">0</strong> Karya</p><p><strong id="followers-count">0</strong> Followers</p><p><strong id="following-count">0</strong> Following</p></div></div></div><div id="follow-btn-container" style="margin-bottom:20px; text-align:center;"></div><hr><h2 style="text-align:left;font-size:1.5em;margin-top:20px;">Karya Penulis</h2><div id="profile-wall" class="mading-wall"></div></div>`;
                document.getElementById('back-to-mading-btn').onclick = renderDashboard;
                const postsSnapshot = await db.collection("posts").where("authorId", "==", authorId).get();
                let posts = [];
                postsSnapshot.forEach(doc => posts.push({ id: doc.id, ...doc.data() }));
                posts.sort((a, b) => (b.timestamp?.toDate() || 0) - (a.timestamp?.toDate() || 0));
                renderPosts(posts, false);
            }
            
            document.getElementById('profile-name').textContent = userData.name;
            document.getElementById('profile-pic-large').textContent = userData.name.charAt(0).toUpperCase();
            document.getElementById('karya-count').textContent = userData.karyaCount || 0;
            document.getElementById('followers-count').textContent = (userData.followers || []).length;
            document.getElementById('following-count').textContent = (userData.following || []).length;
            
            const badgeContainer = document.getElementById('verified-badge-container');
            badgeContainer.innerHTML = (userData.karyaCount >= 10) ? `<svg title="Penulis Aktif (10+ Karya)" class="verified-badge" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M6.267 3.455a3.066 3.066 0 001.745-.723 3.066 3.066 0 013.976 0 3.066 3.066 0 001.745.723 3.066 3.066 0 012.812 2.812c.051.643.304 1.254.723 1.745a3.066 3.066 0 010 3.976 3.066 3.066 0 00-.723 1.745 3.066 3.066 0 01-2.812 2.812 3.066 3.066 0 00-1.745.723 3.066 3.066 0 01-3.976 0 3.066 3.066 0 00-1.745-.723 3.066 3.066 0 01-2.812-2.812 3.066 3.066 0 00-.723-1.745 3.066 3.066 0 010-3.976 3.066 3.066 0 00.723-1.745 3.066 3.066 0 012.812-2.812zm7.44 5.252a.75.75 0 00-1.06-1.06L8.25 10.94l-1.94-1.94a.75.75 0 00-1.06 1.06L7.72 12.5l4.94-4.94a.75.75 0 00.057-.058z" clip-rule="evenodd" /></svg>` : '';

            if (currentUserData.uid !== authorId) {
                const isFollowing = (currentUserData.following || []).includes(authorId);
                const followBtnContainer = document.getElementById('follow-btn-container');
                if (isFollowing) {
                    followBtnContainer.innerHTML = `<button id="unfollow-btn" class="btn btn-secondary" style="width:100%;">Unfollow</button>`;
                } else {
                    followBtnContainer.innerHTML = `<button id="follow-btn" class="btn" style="width:100%;">Follow</button>`;
                }
            } else {
                 document.getElementById('follow-btn-container').innerHTML = '';
            }
            hideLoading();
        }, error => {
            console.error("Gagal memuat profil:", error);
            showCustomAlert("Gagal memuat profil.", "Error");
            renderDashboard();
        });
    }

    async function renderSearchView() {
        cleanupListeners();
        appContainer.innerHTML = `
            <div id="search-view" class="card">
                <button id="back-to-mading-btn" class="back-btn">← Kembali</button>
                <h2>Pencarian</h2>
                <div class="form-group">
                    <input type="text" id="search-input" placeholder="Ketik judul karya atau nama penulis...">
                </div>
                <div id="search-results"></div>
            </div>`;
        document.getElementById('back-to-mading-btn').onclick = renderDashboard;

        const searchInput = document.getElementById('search-input');
        const searchResults = document.getElementById('search-results');
        
        showLoading("Menyiapkan pencarian...");
        const [postsSnapshot, usersSnapshot] = await Promise.all([
            db.collection("posts").get(),
            db.collection("users").get()
        ]);
        const allPosts = postsSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
        const allUsers = usersSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
        hideLoading();
        
        searchInput.oninput = () => {
            const query = searchInput.value.toLowerCase();
            if (!query) {
                searchResults.innerHTML = '';
                return;
            }

            const matchingPosts = allPosts.filter(post => post.title.toLowerCase().includes(query));
            const matchingUsers = allUsers.filter(user => user.name.toLowerCase().includes(query));
            
            searchResults.innerHTML = '';

            if (matchingUsers.length > 0) {
                searchResults.innerHTML += '<h3>Penulis Ditemukan</h3>';
                matchingUsers.forEach(user => {
                    const item = document.createElement('div');
                    item.className = 'search-result-item author-link';
                    item.textContent = user.name;
                    item.dataset.authorId = user.id;
                    searchResults.appendChild(item);
                });
            }

            if (matchingPosts.length > 0) {
                searchResults.innerHTML += '<h3 style="margin-top:20px;">Karya Ditemukan</h3>';
                matchingPosts.forEach(post => {
                    const item = document.createElement('div');
                    item.className = 'search-result-item post-card-clickable';
                    item.innerHTML = `<strong>${post.title}</strong><br><small>oleh: ${post.authorName}</small>`;
                    item.dataset.postId = post.id;
                    searchResults.appendChild(item);
                });
            }

            if (matchingUsers.length === 0 && matchingPosts.length === 0) {
                searchResults.innerHTML = '<p>Tidak ada hasil ditemukan.</p>';
            }
        };
    }
    
    document.addEventListener('click', (e) => {
        const target = e.target;
        
        if (target.closest('.post-card-clickable')) { renderPostDetailPage(target.closest('.post-card-clickable').dataset.postId); }
        if (target.closest('.author-link')) { e.preventDefault(); renderProfilePage(target.closest('.author-link').dataset.authorId); }

        if (target.closest('#like-btn')) { 
            const postId = document.getElementById('post-detail-view')?.dataset.postId;
            if (postId) handleLikePost(postId);
        }
        
        const commentForm = target.closest('#comment-form');
        if (commentForm) {
             commentForm.onsubmit = (event) => {
                event.preventDefault();
                const postId = document.getElementById('post-detail-view')?.dataset.postId;
                if (postId) handleCreateComment(postId, document.getElementById('comment-content').value);
            }
        }

        if (target.closest('#follow-btn')) {
            const authorId = document.getElementById('profile-view')?.dataset.authorId;
            if (authorId) handleFollow(authorId);
        }
        if (target.closest('#unfollow-btn')) {
            const authorId = document.getElementById('profile-view')?.dataset.authorId;
            if (authorId) handleUnfollow(authorId);
        }

        const menuBtn = target.closest('.post-menu-btn');
        if (menuBtn) {
            document.querySelectorAll('.dropdown-menu').forEach(m => {
                if(m.id !== `menu-${menuBtn.dataset.menuId}`) m.style.display = 'none'
            });
            const menu = document.getElementById(`menu-${menuBtn.dataset.menuId}`);
            menu.style.display = menu.style.display === 'block' ? 'none' : 'block';
        } else if (!target.closest('.dropdown-menu')) {
             document.querySelectorAll('.dropdown-menu').forEach(m => m.style.display = 'none');
        }
        
        const editBtn = target.closest('.edit-btn');
        if (editBtn) { 
            e.preventDefault(); 
            showLoading('Memuat data...'); 
            db.collection('posts').doc(editBtn.dataset.postId).get().then(doc => { if(doc.exists) renderPostModal('edit', doc.data(), doc.id) }).finally(()=>hideLoading()); 
        }
        const deleteBtn = target.closest('.delete-btn');
        if (deleteBtn) { e.preventDefault(); handleDeletePost(deleteBtn.dataset.postId); }
    });
    
    document.getElementById('register-form').addEventListener('submit', (e) => { 
        e.preventDefault(); 
        showLoading("Membuat akun..."); 
        const name = document.getElementById('register-name').value; 
        const email = document.getElementById('register-email').value; 
        const password = document.getElementById('register-password').value; 
        auth.createUserWithEmailAndPassword(email, password).then((cred) => { 
            return db.collection("users").doc(cred.user.uid).set({ name: name, email: email, karyaCount: 0, followers: [], following: [] }); 
        }).then(() => { 
            showCustomAlert("Akun berhasil dibuat! Silakan login.", "Sukses"); 
            document.getElementById('show-login').click(); 
            e.target.reset(); 
        }).catch((error) => showCustomAlert(error.message, "Error")).finally(()=>hideLoading()); 
    });
    
    document.getElementById('login-form').addEventListener('submit', (e) => { 
        e.preventDefault(); 
        showLoading("Mencoba masuk..."); 
        const email = document.getElementById('login-email').value; 
        const password = document.getElementById('login-password').value; 
        auth.signInWithEmailAndPassword(email, password).catch((error) => { 
            hideLoading(); 
            showCustomAlert(error.message, "Gagal Login"); 
        }); 
    });
    
    function renderPostModal(mode, postData = {}, postId = '') {
        const isEdit = mode === 'edit';
        modalContainer.innerHTML = `<div id="post-modal" class="modal"><div class="modal-content"><h2>${isEdit ? 'Edit Karya' : 'Kirim Karya Baru'}</h2><form id="post-form"><div class="form-group"><label for="post-title">Judul Karya</label><input type="text" id="post-title" value="${postData.title || ''}" required></div><div class="form-group"><label for="post-content">Isi Karya</label><textarea id="post-content" rows="8" required>${postData.content || ''}</textarea></div><div style="display:flex; gap:10px;"><button type="button" id="close-post-modal-btn" class="btn btn-secondary">Batal</button><button type="submit" class="btn" style="flex-grow:1;">${isEdit ? 'Simpan Perubahan' : 'Publikasikan'}</button></div></form></div></div>`;
        modalContainer.querySelector('#close-post-modal-btn').onclick = () => modalContainer.innerHTML = '';
        modalContainer.querySelector('#post-form').addEventListener('submit', (e) => { e.preventDefault(); if (isEdit) { handleUpdatePost(postId); } else { handleCreatePost(); } });
    }

    function handleCreatePost() { 
        const title = document.getElementById('post-title').value;
        const content = document.getElementById('post-content').value;
        if (containsProfanity(title) || containsProfanity(content)) {
            showCustomAlert("Karya Anda mengandung kata-kata yang tidak pantas. Mohon periksa kembali.", "Peringatan");
            return;
        }
        showLoading("Memublikasikan..."); 
        db.collection("posts").add({ 
            title: title, 
            content: content, 
            authorName: currentUserData.name, 
            authorId: currentUserData.uid, 
            timestamp: firebase.firestore.FieldValue.serverTimestamp(),
            likeCount: 0,
            commentCount: 0,
            likes: []
        }).then(() => { 
            modalContainer.innerHTML = ''; 
            db.collection("users").doc(currentUserData.uid).update({ karyaCount: firebase.firestore.FieldValue.increment(1) });
        }).catch(err => showCustomAlert(err.message)).finally(()=>hideLoading()); 
    }

    function handleUpdatePost(postId) {
        const title = document.getElementById('post-title').value;
        const content = document.getElementById('post-content').value;
        if (containsProfanity(title) || containsProfanity(content)) {
            showCustomAlert("Karya Anda mengandung kata-kata yang tidak pantas. Mohon periksa kembali.", "Peringatan");
            return;
        }
        showLoading("Memperbarui..."); 
        db.collection("posts").doc(postId).update({ 
            title: title, 
            content: content
        }).then(() => { 
            modalContainer.innerHTML = '';
        }).catch(err => showCustomAlert(err.message)).finally(()=>hideLoading());
    }

    async function handleDeletePost(postId) {
        const confirmed = await showCustomConfirm("Yakin ingin menghapus karya ini?");
        if (confirmed) {
            showLoading("Menghapus...");
            const postRef = db.collection("posts").doc(postId);
            const commentsSnapshot = await db.collection("comments").where("postId", "==", postId).get();
            
            const batch = db.batch();
            commentsSnapshot.forEach(doc => batch.delete(doc.ref));
            batch.delete(postRef);
            
            await batch.commit();
            await db.collection("users").doc(currentUserData.uid).update({ karyaCount: firebase.firestore.FieldValue.increment(-1) });
            
            showCustomAlert("Karya berhasil dihapus.");
            renderDashboard();
            hideLoading();
        }
    }
    
    async function handleLikePost(postId) {
        if (!currentUserData) { auth.signOut(); return; }
        const postRef = db.collection("posts").doc(postId);
        
        try {
            await db.runTransaction(async (transaction) => {
                const postDoc = await transaction.get(postRef);
                if (!postDoc.exists) throw "Karya tidak ada!";

                const postData = postDoc.data();
                const authorId = postData.authorId;
                const likes = postData.likes || [];
                let isLiked = likes.includes(currentUserData.uid);

                if (isLiked) {
                    transaction.update(postRef, { 
                        likes: firebase.firestore.FieldValue.arrayRemove(currentUserData.uid),
                        likeCount: firebase.firestore.FieldValue.increment(-1)
                    });
                } else {
                    transaction.update(postRef, { 
                        likes: firebase.firestore.FieldValue.arrayUnion(currentUserData.uid),
                        likeCount: firebase.firestore.FieldValue.increment(1)
                    });
                }
            });
        } catch (error) {
            console.error("Gagal menyukai post:", error);
            showCustomAlert("Gagal memberikan suka.", "Error");
        }
    }

    async function handleCreateComment(postId, content) {
        if (!currentUserData) { auth.signOut(); return; }
        if (!content.trim()) return;
        if (containsProfanity(content)) {
            showCustomAlert("Komentar Anda mengandung kata-kata yang tidak pantas. Mohon periksa kembali.", "Peringatan");
            return;
        }

        showLoading("Mengirim komentar...");
        const postRef = db.collection("posts").doc(postId);

        try {
            await db.collection("comments").add({
                postId: postId,
                content: content,
                authorId: currentUserData.uid,
                authorName: currentUserData.name,
                timestamp: firebase.firestore.FieldValue.serverTimestamp()
            });

            await postRef.update({ commentCount: firebase.firestore.FieldValue.increment(1) });
        } catch (error) {
            console.error("Gagal mengirim komentar:", error);
            showCustomAlert("Gagal mengirim komentar.", "Error");
        } finally {
            hideLoading();
        }
    }
    
    function handleFollow(id){ 
        if (!currentUserData) { auth.signOut(); return; }
        showLoading("Mengikuti..."); 
        const batch=db.batch(); 
        batch.update(db.collection('users').doc(currentUserData.uid),{following:firebase.firestore.FieldValue.arrayUnion(id)}); 
        batch.update(db.collection('users').doc(id),{followers:firebase.firestore.FieldValue.arrayUnion(currentUserData.uid)}); 
        batch.commit().catch(err=>{console.error(err); showCustomAlert("Gagal mengikuti.", "Error"); hideLoading();}); 
    }

    function handleUnfollow(id){ 
        if (!currentUserData) { auth.signOut(); return; }
        showLoading("Batal mengikuti..."); 
        const batch=db.batch(); 
        batch.update(db.collection('users').doc(currentUserData.uid),{following:firebase.firestore.FieldValue.arrayRemove(id)}); 
        batch.update(db.collection('users').doc(id),{followers:firebase.firestore.FieldValue.arrayRemove(currentUserData.uid)}); 
        batch.commit().catch(err=>{console.error(err); showCustomAlert("Gagal batal mengikuti.", "Error"); hideLoading();}); 
    }
</script>
</body>
</html>

