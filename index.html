<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mading Komunitas - Cendekia Aksara</title>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap');
        :root { --primary: #003366; --secondary: #005a9c; --accent: #f0f4f8; }
        body { font-family: 'Poppins', sans-serif; background-color: var(--accent); margin: 0; color: #333; }
        .container { max-width: 900px; margin: 20px auto; padding: 20px; }
        .hidden { display: none !important; }
        .btn { padding: 10px 20px; border: none; border-radius: 8px; color: #fff; background-color: var(--secondary); font-weight: 600; cursor: pointer; transition: background-color 0.2s; }
        .btn:disabled { background-color: #999; cursor: not-allowed; }
        .btn-danger { background-color: #dc3545; }
        .btn-secondary { background-color: #6c757d; }
        .card { background: #fff; padding: 30px; border-radius: 12px; box-shadow: 0 8px 30px rgba(0,0,0,0.1); }
        .form-group { margin-bottom: 20px; }
        .form-group label { display: block; font-weight: 600; margin-bottom: 8px; }
        .form-group input, .form-group textarea { width: 100%; padding: 12px; border: 1px solid #ccc; border-radius: 8px; box-sizing: border-box; font-size: 1em; }
        .header { display: flex; justify-content: space-between; align-items: center; background: #fff; padding: 15px 30px; border-radius: 12px; box-shadow: 0 4px 20px rgba(0,0,0,0.08); }
        .profile-bubble { width: 40px; height: 40px; border-radius: 50%; background-color: var(--primary); color: white; display: flex; justify-content: center; align-items: center; font-weight: bold; cursor: pointer; background-size: cover; background-position: center; flex-shrink: 0; }
        .mading-wall { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 20px; margin-top: 30px; }
        .post-card { position: relative; background: #fff; padding: 20px; border-radius: 12px; box-shadow: 0 4px 20px rgba(0,0,0,0.06); animation: fadeIn 0.5s; display: flex; flex-direction: column; }
        .post-card-clickable { flex-grow: 1; cursor: pointer; }
        .post-card h3 { margin: 0 0 10px; color: var(--primary); }
        .post-card .meta { font-size: 0.8em; color: #6c757d; margin-bottom: 15px; }
        .post-card p { margin: 0; white-space: pre-wrap; line-height: 1.7; display: -webkit-box; -webkit-line-clamp: 4; -webkit-box-orient: vertical; overflow: hidden; }
        .post-card .author { font-size: 0.9em; margin-top: 15px; color: #6c757d; font-weight: 500; }
        .author-link { color: var(--secondary); text-decoration: none; font-weight: 600; cursor: pointer; }
        .author-link:hover { text-decoration: underline; }
        .post-actions { border-top: 1px solid #eee; margin-top: 15px; padding-top: 10px; font-size: 0.9em; color: #6c757d; display: flex; gap: 15px; }
        .modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.6); display: flex; justify-content: center; align-items: center; z-index: 1000; }
        .modal-content { background: #fff; padding: 30px; border-radius: 12px; box-shadow: 0 8px 30px rgba(0,0,0,0.1); width: 90%; max-width: 500px; animation: fadeIn 0.3s; }
        .profile-header { display: flex; flex-direction: column; align-items: center; gap: 20px; margin-bottom: 20px; text-align:center; }
        .profile-pic-large { width: 100px; height: 100px; border-radius: 50%; background-color: var(--primary); color: white; display: flex; justify-content: center; align-items: center; font-weight: bold; font-size: 3em; background-size: cover; background-position: center; position: relative; border: 4px solid white; box-shadow: 0 4px 15px rgba(0,0,0,0.2);}
        .profile-stats { display: flex; gap: 20px; justify-content: center; }
        .verified-badge { width: 24px; height: 24px; color: var(--secondary); }
        .back-btn { background: none; border: none; font-weight: 600; color: var(--secondary); cursor: pointer; font-size: 1em; margin-bottom: 20px; display:flex; align-items:center; gap: 5px; }
        .fab { position: fixed; width: 50px; height: 50px; border-radius: 50%; border: none; color: white; font-size: 24px; cursor: pointer; box-shadow: 0 4px 15px rgba(0,0,0,0.3); display: flex; justify-content: center; align-items: center; z-index: 50;}
        #help-btn { bottom: 30px; left: 30px; background-color: #25D366; }
        #loading-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(255, 255, 255, 0.85); display: flex; flex-direction: column; justify-content: center; align-items: center; z-index: 9999; }
        .progress-spinner { width: 60px; height: 60px; border-radius: 50%; border: 4px solid #e3e9ef; border-top-color: var(--secondary); animation: spin 1s linear infinite; }
        #loading-overlay p { margin-top: 20px; font-size: 1.2em; font-weight: 600; color: var(--primary); }
        .post-menu { position: absolute; top: 15px; right: 15px; }
        .post-menu-btn { background:none; border:none; cursor:pointer; font-size:20px; color:#aaa; padding: 5px;}
        .dropdown-menu { display:none; position:absolute; right:0; top:25px; background:white; border-radius:8px; box-shadow:0 2px 10px rgba(0,0,0,0.2); z-index:10; overflow: hidden;}
        .dropdown-menu a { display:block; padding:8px 15px; color:#333; text-decoration:none; font-size:14px; }
        .dropdown-menu a:hover { background-color:#f0f4f8; }
        #notification-container { position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); z-index: 2000; display: flex; flex-direction: column; gap: 10px; align-items: center; }
        .toast-notification { background-color: rgba(0, 0, 0, 0.8); color: white; padding: 12px 20px; border-radius: 25px; font-size: 0.9em; box-shadow: 0 4px 15px rgba(0,0,0,0.2); animation: slideInUp 0.5s forwards; }
        
        /* Notif Bell */
        .header-actions { display: flex; align-items: center; gap: 10px; position: relative; }
        #notification-btn { background: none; border: none; cursor: pointer; position: relative; color: #6c757d; padding: 5px;}
        #notification-counter { position: absolute; top: -5px; right: -5px; background-color: #dc3545; color: white; border-radius: 50%; width: 18px; height: 18px; font-size: 11px; display: flex; justify-content: center; align-items: center; font-weight: bold; }
        #notification-panel { right: 0; top: 40px; width: 300px; max-height: 400px; overflow-y: auto; }
        .notification-item { padding: 10px 15px; border-bottom: 1px solid #eee; font-size: 14px; }
        .notification-item:last-child { border-bottom: none; }
        
        /* Detail Page Styles */
        .like-btn { padding: 8px 15px; border-radius: 20px; border: 1px solid #ccc; background-color: #f0f4f8; cursor: pointer; transition: all 0.2s; }
        .like-btn.liked { background-color: #e3f2fd; border-color: var(--secondary); color: var(--secondary); font-weight: 600; }
        .comment-section { margin-top: 30px; }
        .comment-list { list-style-type: none; padding: 0; margin-top: 20px; }
        .comment-item { background-color: var(--accent); padding: 15px; border-radius: 8px; margin-bottom: 10px; }
        .comment-item strong { color: var(--primary); }
        .comment-item p { margin: 5px 0 0; }
        
        @keyframes spin { to { transform: rotate(360deg); } }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes slideInUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }

        @media (max-width: 600px) {
            body { background-color: #fff; }
            .container { margin: 0 auto; padding: 10px; }
            .card { box-shadow: none; border-radius: 0; padding: 20px 15px; }
            .header { flex-direction: column; gap: 15px; align-items: stretch; border-radius: 0; }
            .header-actions { justify-content: space-between; }
            #show-post-modal-btn { flex-grow: 1; text-align: center; }
            .header h2 { font-size: 1.2em; word-break: break-word; }
        }
    </style>
</head>
<body>
    <div id="auth-container" class="container card" style="max-width: 400px; margin-top: 5vh;">
        <div id="login-view"><h1>Masuk ke Mading</h1><form id="login-form"><div class="form-group"><label for="login-email">Email</label><input type="email" id="login-email" required></div><div class="form-group"><label for="login-password">Password</label><input type="password" id="login-password" required></div><button type="submit" class="btn" style="width:100%;">Login</button><p style="text-align: center; margin-top: 15px; cursor: pointer; color: #005a9c;" id="show-register">Belum punya akun? Daftar di sini.</p></form></div>
        <div id="register-view" class="hidden"><h1>Daftar Akun Baru</h1><form id="register-form"><div class="form-group"><label for="register-name">Nama Lengkap / Pena</label><input type="text" id="register-name" required></div><div class="form-group"><label for="register-email">Email</label><input type="email" id="register-email" required></div><div class="form-group"><label for="register-password">Password</label><input type="password" id="register-password" required></div><button type="submit" class="btn" style="width:100%;">Daftar</button><p style="text-align: center; margin-top: 15px; cursor: pointer; color: #005a9c;" id="show-login">Sudah punya akun? Masuk.</p></form></div>
    </div>
    
    <div id="app-container" class="container hidden"></div>
    <div id="modal-container"></div>
    <div id="notification-container"></div>
    <a href="https://wa.me/628895615630" target="_blank" id="help-btn" class="fab" title="Butuh Bantuan?"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24" fill="currentColor"><path d="M.057 24l1.687-6.163c-1.041-1.804-1.588-3.849-1.587-5.946.003-6.556 5.338-11.891 11.893-11.891 3.181.001 6.167 1.24 8.413 3.488 2.245 2.248 3.487 5.235 3.487 8.413.003 6.557-5.338 11.892-11.894 11.892-1.99-.001-3.951-.5-5.688-1.448l-6.305 1.654zm6.597-3.807c1.676.995 3.276 1.591 5.392 1.592 5.448 0 9.886-4.434 9.889-9.885.002-5.462-4.433-9.89-9.889-9.89-5.452 0-9.887 4.434-9.889 9.89.001 2.23 1.056 4.411 2.899 6.001l.111.129-.755 2.726 2.735-.74z"/></svg></a>
    <div id="loading-overlay" class="hidden"><div class="progress-spinner"></div><p id="loading-text">Memuat...</p></div>

<script>
    const firebaseConfig = { apiKey: "AIzaSyDpUWUIzPXIZN6rrNtsIqcL6VfOE2RLVl0", authDomain: "mading-cf676.firebaseapp.com", projectId: "mading-cf676", storageBucket: "mading-cf676.firebasestorage.app", messagingSenderId: "72175203671", appId: "1:72175203671:web:7a0676a55beb64bc96ba12" };

    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();

    const authContainer = document.getElementById('auth-container');
    const appContainer = document.getElementById('app-container');
    const modalContainer = document.getElementById('modal-container');
    const loadingOverlay = document.getElementById('loading-overlay');
    const loadingText = document.getElementById('loading-text');
    
    let stopPostsListener = null;
    let stopNotificationListener = null;
    let currentUserData = null;

    function showLoading(message) { loadingText.textContent = message; loadingOverlay.classList.remove('hidden'); }
    function hideLoading() { loadingOverlay.classList.add('hidden'); }
    
    document.getElementById('show-register').onclick = () => { document.getElementById('login-view').classList.add('hidden'); document.getElementById('register-view').classList.remove('hidden'); };
    document.getElementById('show-login').onclick = () => { document.getElementById('register-view').classList.add('hidden'); document.getElementById('login-view').classList.remove('hidden'); };
    
    function renderModal(title, message, buttons) {
        const buttonsHTML = buttons.map(btn => `<button class="btn ${btn.className || ''}" id="${btn.id}">${btn.text}</button>`).join('');
        modalContainer.innerHTML = `<div class="modal"><div class="modal-content"><h2>${title}</h2><p>${message}</p><div style="display:flex; gap:10px; justify-content: flex-end; margin-top:20px;">${buttonsHTML}</div></div></div>`;
    }

    function showCustomAlert(message, title = 'Informasi') {
        renderModal(title, message, [{id: 'modal-ok-btn', text: 'OK', className: 'btn-secondary'}]);
        document.getElementById('modal-ok-btn').onclick = () => { modalContainer.innerHTML = ''; };
    }

    function showCustomConfirm(message, title = 'Konfirmasi') {
        return new Promise(resolve => {
            renderModal(title, message, [{id: 'modal-cancel-btn', text: 'Batal', className: 'btn-secondary'}, {id: 'modal-confirm-btn', text: 'Hapus', className: 'btn-danger'}]);
            document.getElementById('modal-confirm-btn').onclick = () => { modalContainer.innerHTML = ''; resolve(true); };
            document.getElementById('modal-cancel-btn').onclick = () => { modalContainer.innerHTML = ''; resolve(false); };
        });
    }

    function showToastNotification(message) {
        const container = document.getElementById('notification-container');
        const toast = document.createElement('div');
        toast.className = 'toast-notification';
        toast.textContent = message;
        container.appendChild(toast);
        setTimeout(() => { toast.remove(); }, 4000);
    }

    function setupNotificationListener(userId) {
        if (stopNotificationListener) stopNotificationListener();

        stopNotificationListener = db.collection("users").doc(userId).collection("notifications")
            .orderBy("timestamp", "desc")
            .onSnapshot(snapshot => {
                const notifCounter = document.getElementById('notification-counter');
                const notifPanel = document.getElementById('notification-panel');

                if (notifCounter) {
                    notifCounter.textContent = snapshot.size;
                    notifCounter.classList.toggle('hidden', snapshot.empty);
                }

                if (notifPanel) {
                    notifPanel.innerHTML = '';
                    if(snapshot.empty){
                        notifPanel.innerHTML = '<div class="notification-item">Tidak ada notifikasi baru.</div>';
                    } else {
                        snapshot.forEach(doc => {
                            const notif = doc.data();
                            const item = document.createElement('div');
                            item.className = 'notification-item';
                            item.textContent = notif.message;
                            notifPanel.appendChild(item);
                        });
                    }
                }

                snapshot.docChanges().forEach(change => {
                    if (change.type === "added" && change.doc.data().timestamp.toDate() > new Date(Date.now() - 5000)) {
                        showToastNotification(change.doc.data().message);
                    }
                });
            });
    }

    auth.onAuthStateChanged(user => {
        showLoading('Mengecek sesi...');
        if (user) {
            db.collection("users").doc(user.uid).onSnapshot(doc => {
                if(doc.exists) {
                    const wasNull = currentUserData === null;
                    currentUserData = { uid: user.uid, ...doc.data() };
                    if (wasNull) {
                         renderDashboard();
                    }
                    hideLoading();
                } else { auth.signOut(); }
            }, err => { console.error(err); auth.signOut(); hideLoading(); });
        } else {
            currentUserData = null;
            authContainer.classList.remove('hidden');
            appContainer.classList.add('hidden');
            if (stopPostsListener) stopPostsListener();
            if (stopNotificationListener) stopNotificationListener();
            hideLoading();
        }
    });

    function renderDashboard() {
        authContainer.classList.add('hidden');
        appContainer.classList.remove('hidden');
        appContainer.innerHTML = `
            <div id="mading-view">
                <div class="header">
                    <div style="display:flex; align-items:center; gap:15px;">
                        <div id="profile-bubble" class="profile-bubble" title="Lihat Profil Saya">${currentUserData.name.charAt(0).toUpperCase()}</div>
                        <div>
                            <h2 style="text-align:left; margin:0;">Selamat Datang, ${currentUserData.name}!</h2>
                            <button id="logout-btn" class="btn-danger" style="padding: 4px 8px; font-size: 12px; border-radius: 6px;">Logout</button>
                        </div>
                    </div>
                    <div class="header-actions">
                        <button id="notification-btn" title="Notifikasi">
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="currentColor"><path d="M12 22c1.1 0 2-.9 2-2h-4c0 1.1.9 2 2 2zm6-6v-5c0-3.07-1.63-5.64-4.5-6.32V4c0-.83-.67-1.5-1.5-1.5s-1.5.67-1.5 1.5v.68C7.64 5.36 6 7.92 6 11v5l-2 2v1h16v-1l-2-2zm-2 1H8v-6c0-2.48 1.51-4.5 4-4.5s4 2.02 4 4.5v6z"/></svg>
                            <span id="notification-counter" class="hidden">0</span>
                        </button>
                        <div id="notification-panel" class="dropdown-menu"></div>
                        <button id="show-post-modal-btn" class="btn">Kirim Karya Baru +</button>
                    </div>
                </div>
                <div id="mading-wall" class="mading-wall"></div>
            </div>`;
        document.getElementById('profile-bubble').onclick = () => renderProfilePage(currentUserData.uid);
        document.getElementById('logout-btn').onclick = () => auth.signOut();
        document.getElementById('show-post-modal-btn').onclick = () => renderPostModal('create');
        document.getElementById('notification-btn').onclick = () => {
            const panel = document.getElementById('notification-panel');
            panel.style.display = panel.style.display === 'block' ? 'none' : 'block';
        };
        fetchAndRenderPosts();
        setupNotificationListener(currentUserData.uid);
    }

    async function fetchAndRenderPosts() {
        if (stopPostsListener) {
            stopPostsListener();
            stopPostsListener = null;
        }
        const madingWall = document.getElementById('mading-wall');
        if (!madingWall) return;
        madingWall.innerHTML = '<p>Memuat beranda...</p>';
        
        const following = currentUserData.following || [];

        if (following.length === 0) {
            stopPostsListener = db.collection("posts").orderBy("timestamp", "desc").onSnapshot(querySnapshot => {
                if (!document.getElementById('mading-wall')) return;
                const posts = querySnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderPosts(posts);
            }, error => {
                console.error("Gagal memuat beranda umum:", error);
                madingWall.innerHTML = '<p>Gagal memuat karya.</p>';
            });
            return;
        }

        try {
            const postPromises = following.map(uid => db.collection("posts").where("authorId", "==", uid).limit(5).get());
            const postSnapshots = await Promise.all(postPromises);
            let followedPosts = [];
            postSnapshots.forEach(snapshot => snapshot.forEach(doc => followedPosts.push({ id: doc.id, ...doc.data() })));
            
            followedPosts.sort((a, b) => (b.timestamp?.toDate() || 0) - (a.timestamp?.toDate() || 0));
            const topFollowedPosts = followedPosts.slice(0, 2);
            const followedPostIds = new Set(topFollowedPosts.map(p => p.id));

            const publicSnapshot = await db.collection("posts").orderBy("timestamp", "desc").limit(20).get();
            let publicPosts = [];
            publicSnapshot.forEach(doc => publicPosts.push({ id: doc.id, ...doc.data() }));

            const filteredPublicPosts = publicPosts.filter(p => !followedPostIds.has(p.id));

            madingWall.innerHTML = '';

            if (topFollowedPosts.length > 0) {
                const followedHeader = document.createElement('div');
                followedHeader.style.gridColumn = '1 / -1';
                followedHeader.innerHTML = `<h2 style="font-size: 1.5em; color: var(--primary); margin-bottom: 0;">Karya dari yang Anda ikuti</h2>`;
                madingWall.appendChild(followedHeader);
                renderPosts(topFollowedPosts, true);
            }

            const publicHeader = document.createElement('div');
            publicHeader.style.gridColumn = '1 / -1';
            publicHeader.style.marginTop = topFollowedPosts.length > 0 ? '40px' : '0';
            publicHeader.innerHTML = `<h2 style="font-size: 1.5em; color: var(--primary); margin-bottom: 0;">Jelajahi Karya Lain</h2>`;
            madingWall.appendChild(publicHeader);
            
            if (filteredPublicPosts.length > 0) {
                renderPosts(filteredPublicPosts, true);
            } else {
                madingWall.innerHTML += '<p>Tidak ada karya lain untuk dijelajahi saat ini.</p>';
            }
        } catch (error) {
            console.error("Gagal memuat beranda hibrida:", error);
            madingWall.innerHTML = `<p>Gagal memuat beranda. Coba muat ulang halaman.</p>`;
        }
    }
    
    function renderPosts(posts, append = false) {
        const wallId = append ? 'mading-wall' : (document.getElementById('profile-wall') ? 'profile-wall' : 'mading-wall');
        const wall = document.getElementById(wallId);
        if(!wall) return;
        if (!append) wall.innerHTML = '';
        if (posts.length === 0 && !append) {
            wall.innerHTML = '<p>Belum ada karya yang dikirim.</p>';
            return;
        }

        posts.forEach(post => {
            const postCard = document.createElement('div');
            postCard.className = 'post-card';
            const postDate = post.timestamp ? post.timestamp.toDate().toLocaleString('id-ID') : 'Baru saja';
            let menuButton = '';
            if (currentUserData && currentUserData.uid === post.authorId) {
                menuButton = `<div class="post-menu"><button class="post-menu-btn" data-menu-id="${post.id}">&#8942;</button><div id="menu-${post.id}" class="dropdown-menu"><a href="#" class="edit-btn" data-post-id="${post.id}">Edit</a><a href="#" class="delete-btn" data-post-id="${post.id}">Hapus</a></div></div>`;
            }
            postCard.innerHTML = `
                ${menuButton}
                <div class="post-card-clickable" data-post-id="${post.id}">
                    <h3>${post.title}</h3>
                    <p class="meta">${postDate}</p>
                    <p>${post.content}</p>
                </div>
                <div class="post-actions">
                    <span>❤️ ${post.likeCount || 0} Suka</span>
                    <span>💬 ${post.commentCount || 0} Komentar</span>
                </div>
                <p class="author">oleh: <a href="#" class="author-link" data-author-id="${post.authorId}">${post.authorName}</a></p>
            `;
            wall.appendChild(postCard);
        });
    }

    async function renderPostDetailPage(postId) {
        showLoading("Memuat karya...");
        if (stopPostsListener) stopPostsListener();

        try {
            const postDoc = await db.collection("posts").doc(postId).get();
            if (!postDoc.exists) throw new Error("Karya tidak ditemukan.");
            const postData = { id: postDoc.id, ...postDoc.data() };
            
            const commentsSnapshot = await db.collection("comments").where("postId", "==", postId).get();
            const comments = commentsSnapshot.docs.map(doc => doc.data());
            comments.sort((a, b) => (a.timestamp?.toDate() || 0) - (b.timestamp?.toDate() || 0));


            const isLiked = postData.likes && postData.likes.includes(currentUserData.uid);

            appContainer.innerHTML = `
                <div id="post-detail-view" class="card">
                    <button id="back-to-mading-btn" class="back-btn">← Kembali</button>
                    <h1>${postData.title}</h1>
                    <p class="meta">oleh <a href="#" class="author-link" data-author-id="${postData.authorId}">${postData.authorName}</a> pada ${postData.timestamp ? postData.timestamp.toDate().toLocaleString('id-ID') : ''}</p>
                    <p style="white-space: pre-wrap; line-height: 1.8;">${postData.content}</p>
                    <div style="margin-top: 20px; padding-top: 20px; border-top: 1px solid #eee;">
                        <button id="like-btn" class="like-btn ${isLiked ? 'liked' : ''}">
                           ❤️ <span id="like-count">${postData.likeCount || 0}</span> Suka
                        </button>
                    </div>
                    <div class="comment-section">
                        <h3>Komentar (${postData.commentCount || 0})</h3>
                        <form id="comment-form" class="form-group">
                            <textarea id="comment-content" rows="3" placeholder="Tulis komentar Anda..." required></textarea>
                            <button type="submit" class="btn" style="margin-top:10px;">Kirim</button>
                        </form>
                        <ul id="comment-list" class="comment-list"></ul>
                    </div>
                </div>`;

            const commentList = document.getElementById('comment-list');
            if(comments.length > 0) {
                comments.forEach(comment => {
                    const li = document.createElement('li');
                    li.className = 'comment-item';
                    li.innerHTML = `<strong>${comment.authorName}</strong><p>${comment.content}</p>`;
                    commentList.appendChild(li);
                });
            } else {
                commentList.innerHTML = '<p>Jadilah yang pertama berkomentar!</p>';
            }

            document.getElementById('back-to-mading-btn').onclick = renderDashboard;
            appContainer.querySelector('.author-link').onclick = (e) => renderProfilePage(e.target.dataset.authorId);
            document.getElementById('like-btn').onclick = () => handleLikePost(postId, postData.authorId);
            document.getElementById('comment-form').onsubmit = (e) => {
                e.preventDefault();
                handleCreateComment(postId, postData.authorId);
            };

        } catch (error) {
            console.error("Gagal membuka detail karya:", error);
            showCustomAlert("Gagal membuka detail karya.", "Error");
            renderDashboard();
        } finally {
            hideLoading();
        }
    }

    async function renderProfilePage(authorId) {
        showLoading("Memuat profil...");
        if (stopPostsListener) stopPostsListener();
        
        try {
            if (!currentUserData) throw new Error("Pengguna tidak login");

            appContainer.innerHTML = `<div id="profile-view" class="card"><button id="back-to-mading-btn" class="back-btn">← Kembali</button><div class="profile-header"><div id="profile-pic-large" class="profile-pic-large"></div><div><div style="display:flex;align-items:center;gap:10px;justify-content:center;"><h1 id="profile-name" style="text-align:center;margin:0;"></h1><span id="verified-badge-container"></span></div><div class="profile-stats"><p><strong id="karya-count">0</strong> Karya</p><p><strong id="followers-count">0</strong> Followers</p><p><strong id="following-count">0</strong> Following</p></div></div></div><div id="follow-btn-container" style="margin-bottom:20px; text-align:center;"></div><hr><h2 style="text-align:left;font-size:1.5em;margin-top:20px;">Karya Penulis</h2><div id="profile-wall" class="mading-wall"></div></div>`;
            
            document.getElementById('back-to-mading-btn').onclick = renderDashboard;

            const userDoc = await db.collection("users").doc(authorId).get();
            if (!userDoc.exists) throw new Error("Penulis tidak ditemukan");
            const userData = userDoc.data();
            
            document.getElementById('profile-name').textContent = userData.name;
            document.getElementById('profile-pic-large').textContent = userData.name.charAt(0).toUpperCase();
            document.getElementById('karya-count').textContent = userData.karyaCount || 0;
            document.getElementById('followers-count').textContent = (userData.followers || []).length;
            document.getElementById('following-count').textContent = (userData.following || []).length;
            
            const badgeContainer = document.getElementById('verified-badge-container');
            if (userData.karyaCount >= 10) { 
                badgeContainer.innerHTML = `<svg title="Penulis Aktif (10+ Karya)" class="verified-badge" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M6.267 3.455a3.066 3.066 0 001.745-.723 3.066 3.066 0 013.976 0 3.066 3.066 0 001.745.723 3.066 3.066 0 012.812 2.812c.051.643.304 1.254.723 1.745a3.066 3.066 0 010 3.976 3.066 3.066 0 00-.723 1.745 3.066 3.066 0 01-2.812 2.812 3.066 3.066 0 00-1.745.723 3.066 3.066 0 01-3.976 0 3.066 3.066 0 00-1.745-.723 3.066 3.066 0 01-2.812-2.812 3.066 3.066 0 00-.723-1.745 3.066 3.066 0 010-3.976 3.066 3.066 0 00.723-1.745 3.066 3.066 0 012.812-2.812zm7.44 5.252a.75.75 0 00-1.06-1.06L8.25 10.94l-1.94-1.94a.75.75 0 00-1.06 1.06L7.72 12.5l4.94-4.94a.75.75 0 00.057-.058z" clip-rule="evenodd" /></svg>`; 
            }

            if (currentUserData.uid !== authorId) {
                const isFollowing = (currentUserData.following || []).includes(authorId);
                const followBtnContainer = document.getElementById('follow-btn-container');
                if (isFollowing) {
                    followBtnContainer.innerHTML = `<button id="unfollow-btn" class="btn btn-secondary" style="width:100%;">Unfollow</button>`;
                    document.getElementById('unfollow-btn').onclick = () => handleUnfollow(authorId);
                } else {
                    followBtnContainer.innerHTML = `<button id="follow-btn" class="btn" style="width:100%;">Follow</button>`;
                    document.getElementById('follow-btn').onclick = () => handleFollow(authorId);
                }
            }
            
            const postsSnapshot = await db.collection("posts").where("authorId", "==", authorId).get();
            let posts = [];
            postsSnapshot.forEach(doc => posts.push({ id: doc.id, ...doc.data() }));
            posts.sort((a, b) => (b.timestamp?.toDate() || 0) - (a.timestamp?.toDate() || 0));

            renderPosts(posts, false); // Renders to profile-wall because it's the only wall present
            
        } catch(error) {
            console.error("Gagal memuat profil:", error);
            showCustomAlert("Gagal memuat profil.", "Error");
            renderDashboard();
        } finally {
            hideLoading();
        }
    }
    
    appContainer.addEventListener('click', e => {
        const target = e.target;
        if (target.closest('.post-card-clickable')) { renderPostDetailPage(target.closest('.post-card-clickable').dataset.postId); }
        if (target.matches('.author-link')) { e.preventDefault(); renderProfilePage(target.dataset.authorId); }
        const menuBtn = target.closest('.post-menu-btn');
        if (menuBtn) {
            const menu = document.getElementById(`menu-${menuBtn.dataset.menuId}`);
            menu.style.display = menu.style.display === 'block' ? 'none' : 'block';
        }
        const editBtn = target.closest('.edit-btn');
        if (editBtn) { 
            e.preventDefault(); 
            showLoading('Memuat data...'); 
            db.collection('posts').doc(editBtn.dataset.postId).get().then(doc => { if(doc.exists) renderPostModal('edit', doc.data(), doc.id) }).finally(()=>hideLoading()); 
        }
        const deleteBtn = target.closest('.delete-btn');
        if (deleteBtn) { e.preventDefault(); handleDeletePost(deleteBtn.dataset.postId); }
    });
    
    document.getElementById('register-form').addEventListener('submit', (e) => { 
        e.preventDefault(); 
        showLoading("Membuat akun..."); 
        const name = document.getElementById('register-name').value; 
        const email = document.getElementById('register-email').value; 
        const password = document.getElementById('register-password').value; 
        auth.createUserWithEmailAndPassword(email, password).then((cred) => { 
            return db.collection("users").doc(cred.user.uid).set({ name: name, email: email, karyaCount: 0, followers: [], following: [] }); 
        }).then(() => { 
            showCustomAlert("Akun berhasil dibuat! Silakan login.", "Sukses"); 
            document.getElementById('show-login').click(); 
            e.target.reset(); 
        }).catch((error) => showCustomAlert(error.message, "Error")).finally(()=>hideLoading()); 
    });
    
    document.getElementById('login-form').addEventListener('submit', (e) => { 
        e.preventDefault(); 
        showLoading("Mencoba masuk..."); 
        const email = document.getElementById('login-email').value; 
        const password = document.getElementById('login-password').value; 
        auth.signInWithEmailAndPassword(email, password).catch((error) => { 
            hideLoading(); 
            showCustomAlert(error.message, "Gagal Login"); 
        }); 
    });
    
    function renderPostModal(mode, postData = {}, postId = '') {
        const isEdit = mode === 'edit';
        modalContainer.innerHTML = `<div id="post-modal" class="modal"><div class="modal-content"><h2>${isEdit ? 'Edit Karya' : 'Kirim Karya Baru'}</h2><form id="post-form"><div class="form-group"><label for="post-title">Judul Karya</label><input type="text" id="post-title" value="${postData.title || ''}" required></div><div class="form-group"><label for="post-content">Isi Karya</label><textarea id="post-content" rows="8" required>${postData.content || ''}</textarea></div><div style="display:flex; gap:10px;"><button type="button" id="close-post-modal-btn" class="btn btn-secondary">Batal</button><button type="submit" class="btn" style="flex-grow:1;">${isEdit ? 'Simpan Perubahan' : 'Publikasikan'}</button></div></form></div></div>`;
        modalContainer.querySelector('#close-post-modal-btn').onclick = () => modalContainer.innerHTML = '';
        modalContainer.querySelector('#post-form').addEventListener('submit', (e) => { e.preventDefault(); if (isEdit) { handleUpdatePost(postId); } else { handleCreatePost(); } });
    }

    function handleCreatePost() { 
        showLoading("Memublikasikan..."); 
        db.collection("posts").add({ 
            title: document.getElementById('post-title').value, 
            content: document.getElementById('post-content').value, 
            authorName: currentUserData.name, 
            authorId: currentUserData.uid, 
            timestamp: firebase.firestore.FieldValue.serverTimestamp(),
            likeCount: 0,
            commentCount: 0,
            likes: []
        }).then(() => { 
            modalContainer.innerHTML = ''; 
            db.collection("users").doc(currentUserData.uid).update({ karyaCount: firebase.firestore.FieldValue.increment(1) }); 
        }).catch(err => showCustomAlert(err.message)).finally(()=>hideLoading()); 
    }

    function handleUpdatePost(postId) {
        showLoading("Memperbarui..."); 
        db.collection("posts").doc(postId).update({ 
            title: document.getElementById('post-title').value, 
            content: document.getElementById('post-content').value 
        }).then(() => { 
            modalContainer.innerHTML = '';
            showToastNotification("Karya berhasil diperbarui.");
        }).catch(err => showCustomAlert(err.message)).finally(()=>hideLoading());
    }

    async function handleDeletePost(postId) {
        const confirmed = await showCustomConfirm("Yakin ingin menghapus karya ini?");
        if (confirmed) {
            showLoading("Menghapus...");
            const postRef = db.collection("posts").doc(postId);
            const commentsSnapshot = await db.collection("comments").where("postId", "==", postId).get();
            
            const batch = db.batch();
            commentsSnapshot.forEach(doc => batch.delete(doc.ref));
            batch.delete(postRef);
            
            await batch.commit();
            await db.collection("users").doc(currentUserData.uid).update({ karyaCount: firebase.firestore.FieldValue.increment(-1) });
            
            showToastNotification("Karya berhasil dihapus.");
            renderDashboard();
            hideLoading();
        }
    }
    
    async function handleLikePost(postId, authorId) {
        const postRef = db.collection("posts").doc(postId);
        const user = auth.currentUser;
        
        try {
            await db.runTransaction(async (transaction) => {
                const postDoc = await transaction.get(postRef);
                if (!postDoc.exists) throw "Karya tidak ada!";

                const postData = postDoc.data();
                const likes = postData.likes || [];
                let newLikes = [...likes];
                let newLikeCount = postData.likeCount || 0;
                let isLiked = newLikes.includes(user.uid);

                if (isLiked) {
                    newLikes = newLikes.filter(uid => uid !== user.uid);
                    newLikeCount--;
                } else {
                    newLikes.push(user.uid);
                    newLikeCount++;
                }
                
                transaction.update(postRef, { likes: newLikes, likeCount: newLikeCount });
                
                if (!isLiked && user.uid !== authorId) {
                    db.collection("users").doc(authorId).collection("notifications").add({
                        message: `${currentUserData.name} menyukai karya Anda: "${postData.title.substring(0, 20)}..."`,
                        timestamp: firebase.firestore.FieldValue.serverTimestamp()
                    });
                }
            });

            const likeBtn = document.getElementById('like-btn');
            const likeCountSpan = document.getElementById('like-count');
            const currentCount = parseInt(likeCountSpan.textContent);
            
            if (likeBtn.classList.contains('liked')) {
                likeBtn.classList.remove('liked');
                likeCountSpan.textContent = currentCount - 1;
            } else {
                likeBtn.classList.add('liked');
                likeCountSpan.textContent = currentCount + 1;
            }
        } catch (error) {
            console.error("Gagal menyukai post:", error);
            showCustomAlert("Gagal memberikan suka.", "Error");
        }
    }

    async function handleCreateComment(postId, authorId) {
        const content = document.getElementById('comment-content').value;
        if (!content.trim()) return;

        showLoading("Mengirim komentar...");
        const user = auth.currentUser;
        const postRef = db.collection("posts").doc(postId);

        try {
            await db.collection("comments").add({
                postId: postId,
                content: content,
                authorId: user.uid,
                authorName: currentUserData.name,
                timestamp: firebase.firestore.FieldValue.serverTimestamp()
            });

            await postRef.update({ commentCount: firebase.firestore.FieldValue.increment(1) });
            
            if (user.uid !== authorId) {
                const postData = (await postRef.get()).data();
                db.collection("users").doc(authorId).collection("notifications").add({
                    message: `${currentUserData.name} mengomentari: "${postData.title.substring(0, 20)}..."`,
                    timestamp: firebase.firestore.FieldValue.serverTimestamp()
                });
            }

            renderPostDetailPage(postId);
        } catch (error) {
            console.error("Gagal mengirim komentar:", error);
            showCustomAlert("Gagal mengirim komentar.", "Error");
        } finally {
            hideLoading();
        }
    }

    function handleFollow(id){ 
        showLoading("Mengikuti..."); 
        const user = auth.currentUser;
        const batch=db.batch(); 
        batch.update(db.collection('users').doc(user.uid),{following:firebase.firestore.FieldValue.arrayUnion(id)}); 
        batch.update(db.collection('users').doc(id),{followers:firebase.firestore.FieldValue.arrayUnion(user.uid)}); 
        batch.commit().then(() => {
            renderProfilePage(id);
        }).catch(err=>{console.error(err); showCustomAlert("Gagal mengikuti.", "Error"); hideLoading();}); 
    }

    function handleUnfollow(id){ 
        showLoading("Batal mengikuti..."); 
        const user = auth.currentUser;
        const batch=db.batch(); 
        batch.update(db.collection('users').doc(user.uid),{following:firebase.firestore.FieldValue.arrayRemove(id)}); 
        batch.update(db.collection('users').doc(id),{followers:firebase.firestore.FieldValue.arrayRemove(user.uid)}); 
        batch.commit().then(() => {
            renderProfilePage(id);
        }).catch(err=>{console.error(err); showCustomAlert("Gagal batal mengikuti.", "Error"); hideLoading();}); 
    }
</script>
</body>
</html>

