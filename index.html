<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mading Komunitas - Cendekia Aksara</title>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap');
        :root { --primary: #003366; --secondary: #005a9c; --accent: #f0f4f8; }
        body { font-family: 'Poppins', sans-serif; background-color: var(--accent); margin: 0; color: #333; }
        .container { max-width: 900px; margin: 20px auto; padding: 20px; }
        .hidden { display: none !important; }
        .btn { padding: 10px 20px; border: none; border-radius: 8px; color: #fff; background-color: var(--secondary); font-weight: 600; cursor: pointer; transition: background-color 0.2s; }
        .btn:disabled { background-color: #999; cursor: not-allowed; }
        .btn-danger { background-color: #dc3545; }
        .btn-secondary { background-color: #6c757d; }
        .card { background: #fff; padding: 30px; border-radius: 12px; box-shadow: 0 8px 30px rgba(0,0,0,0.1); }
        .form-group { margin-bottom: 20px; }
        .form-group label { display: block; font-weight: 600; margin-bottom: 8px; }
        .form-group input, .form-group textarea { width: 100%; padding: 12px; border: 1px solid #ccc; border-radius: 8px; box-sizing: border-box; font-size: 1em; }
        .header { display: flex; justify-content: space-between; align-items: center; background: #fff; padding: 15px 30px; border-radius: 12px; box-shadow: 0 4px 20px rgba(0,0,0,0.08); }
        .profile-bubble { width: 40px; height: 40px; border-radius: 50%; background-color: var(--primary); color: white; display: flex; justify-content: center; align-items: center; font-weight: bold; cursor: pointer; background-size: cover; background-position: center; flex-shrink: 0; }
        .mading-wall { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 20px; margin-top: 30px; }
        .post-card { position: relative; background: #fff; padding: 20px; border-radius: 12px; box-shadow: 0 4px 20px rgba(0,0,0,0.06); animation: fadeIn 0.5s; }
        .post-card h3 { margin: 0 0 10px; color: var(--primary); }
        .post-card .meta { font-size: 0.8em; color: #6c757d; margin-bottom: 10px; }
        .post-card p { margin: 0; white-space: pre-wrap; line-height: 1.7; }
        .post-card .author { font-size: 0.9em; margin-top: 15px; color: #6c757d; font-weight: 500; }
        .author-link { color: var(--secondary); text-decoration: none; font-weight: 600; cursor: pointer; }
        .author-link:hover { text-decoration: underline; }
        .modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.6); display: flex; justify-content: center; align-items: center; z-index: 1000; }
        .modal-content { background: #fff; padding: 30px; border-radius: 12px; box-shadow: 0 8px 30px rgba(0,0,0,0.1); width: 90%; max-width: 500px; animation: fadeIn 0.3s; }
        .profile-header { display: flex; flex-direction: column; align-items: center; gap: 20px; margin-bottom: 20px; text-align:center; }
        .profile-pic-large { width: 100px; height: 100px; border-radius: 50%; background-color: var(--primary); color: white; display: flex; justify-content: center; align-items: center; font-weight: bold; font-size: 3em; background-size: cover; background-position: center; position: relative; border: 4px solid white; box-shadow: 0 4px 15px rgba(0,0,0,0.2);}
        .profile-stats { display: flex; gap: 20px; justify-content: center; }
        .verified-badge { width: 24px; height: 24px; color: var(--secondary); }
        .back-btn { background: none; border: none; font-weight: 600; color: var(--secondary); cursor: pointer; font-size: 1em; margin-bottom: 20px; }
        .fab { position: fixed; width: 50px; height: 50px; border-radius: 50%; border: none; color: white; font-size: 24px; cursor: pointer; box-shadow: 0 4px 15px rgba(0,0,0,0.3); display: flex; justify-content: center; align-items: center; z-index: 50;}
        #help-btn { bottom: 30px; left: 30px; background-color: #25D366; }
        #loading-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(255, 255, 255, 0.85); display: flex; flex-direction: column; justify-content: center; align-items: center; z-index: 9999; }
        .progress-spinner { width: 60px; height: 60px; border-radius: 50%; border: 4px solid #e3e9ef; border-top-color: var(--secondary); animation: spin 1s linear infinite; }
        #loading-overlay p { margin-top: 20px; font-size: 1.2em; font-weight: 600; color: var(--primary); }
        .post-menu { position: absolute; top: 15px; right: 15px; }
        .post-menu-btn { background:none; border:none; cursor:pointer; font-size:20px; color:#aaa; padding: 5px;}
        .dropdown-menu { display:none; position:absolute; right:0; top:25px; background:white; border-radius:8px; box-shadow:0 2px 10px rgba(0,0,0,0.2); z-index:10; overflow: hidden;}
        .dropdown-menu a { display:block; padding:8px 15px; color:#333; text-decoration:none; font-size:14px; }
        .dropdown-menu a:hover { background-color:#f0f4f8; }
        #notification-container { position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); z-index: 2000; display: flex; flex-direction: column; gap: 10px; align-items: center; }
        .toast-notification { background-color: rgba(0, 0, 0, 0.8); color: white; padding: 12px 20px; border-radius: 25px; font-size: 0.9em; box-shadow: 0 4px 15px rgba(0,0,0,0.2); animation: slideInUp 0.5s forwards; }
        @keyframes spin { to { transform: rotate(360deg); } }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes slideInUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }

        @media (max-width: 600px) {
            body { background-color: #fff; } /* Latar belakang putih di HP */
            .container { margin: 0 auto; padding: 10px; }
            .card { box-shadow: none; border-radius: 0; padding: 20px 15px; } /* Hilangkan bayangan kartu */
            .header { flex-direction: column; gap: 15px; align-items: stretch; border-radius: 0; }
            #show-post-modal-btn { width: 100%; text-align: center; }
            .header h2 { font-size: 1.2em; word-break: break-word; }
        }
    </style>
</head>
<body>
    <div id="auth-container" class="container card" style="max-width: 400px; margin-top: 5vh;">
        <div id="login-view"><h1>Masuk ke Mading</h1><form id="login-form"><div class="form-group"><label for="login-email">Email</label><input type="email" id="login-email" required></div><div class="form-group"><label for="login-password">Password</label><input type="password" id="login-password" required></div><button type="submit" class="btn" style="width:100%;">Login</button><p style="text-align: center; margin-top: 15px; cursor: pointer; color: #005a9c;" id="show-register">Belum punya akun? Daftar di sini.</p></form></div>
        <div id="register-view" class="hidden"><h1>Daftar Akun Baru</h1><form id="register-form"><div class="form-group"><label for="register-name">Nama Lengkap / Pena</label><input type="text" id="register-name" required></div><div class="form-group"><label for="register-email">Email</label><input type="email" id="register-email" required></div><div class="form-group"><label for="register-password">Password</label><input type="password" id="register-password" required></div><button type="submit" class="btn" style="width:100%;">Daftar</button><p style="text-align: center; margin-top: 15px; cursor: pointer; color: #005a9c;" id="show-login">Sudah punya akun? Masuk.</p></form></div>
    </div>
    
    <div id="app-container" class="container hidden"></div>
    <div id="modal-container"></div>
    <div id="notification-container"></div>
    <a href="https://wa.me/628895615630" target="_blank" id="help-btn" class="fab" title="Butuh Bantuan?"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24" fill="currentColor"><path d="M.057 24l1.687-6.163c-1.041-1.804-1.588-3.849-1.587-5.946.003-6.556 5.338-11.891 11.893-11.891 3.181.001 6.167 1.24 8.413 3.488 2.245 2.248 3.487 5.235 3.487 8.413.003 6.557-5.338 11.892-11.894 11.892-1.99-.001-3.951-.5-5.688-1.448l-6.305 1.654zm6.597-3.807c1.676.995 3.276 1.591 5.392 1.592 5.448 0 9.886-4.434 9.889-9.885.002-5.462-4.433-9.89-9.889-9.89-5.452 0-9.887 4.434-9.889 9.89.001 2.23 1.056 4.411 2.899 6.001l.111.129-.755 2.726 2.735-.74z"/></svg></a>
    <div id="loading-overlay" class="hidden"><div class="progress-spinner"></div><p id="loading-text">Memuat...</p></div>

<script>
    const firebaseConfig = { apiKey: "AIzaSyDpUWUIzPXIZN6rrNtsIqcL6VfOE2RLVl0", authDomain: "mading-cf676.firebaseapp.com", projectId: "mading-cf676", storageBucket: "mading-cf676.firebasestorage.app", messagingSenderId: "72175203671", appId: "1:72175203671:web:7a0676a55beb64bc96ba12" };

    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();

    const authContainer = document.getElementById('auth-container');
    const appContainer = document.getElementById('app-container');
    const modalContainer = document.getElementById('modal-container');
    const loadingOverlay = document.getElementById('loading-overlay');
    const loadingText = document.getElementById('loading-text');
    
    let stopPostsListener = null;
    let stopNotificationListener = null;

    function showLoading(message) { loadingText.textContent = message; loadingOverlay.classList.remove('hidden'); }
    function hideLoading() { loadingOverlay.classList.add('hidden'); }
    
    document.getElementById('show-register').onclick = () => { document.getElementById('login-view').classList.add('hidden'); document.getElementById('register-view').classList.remove('hidden'); };
    document.getElementById('show-login').onclick = () => { document.getElementById('register-view').classList.add('hidden'); document.getElementById('login-view').classList.remove('hidden'); };
    
    function renderModal(title, message, buttons) {
        const buttonsHTML = buttons.map(btn => `<button class="btn ${btn.className || ''}" id="${btn.id}">${btn.text}</button>`).join('');
        modalContainer.innerHTML = `<div class="modal"><div class="modal-content"><h2>${title}</h2><p>${message}</p><div style="display:flex; gap:10px; justify-content: flex-end; margin-top:20px;">${buttonsHTML}</div></div></div>`;
    }

    function showCustomAlert(message, title = 'Informasi') {
        renderModal(title, message, [{id: 'modal-ok-btn', text: 'OK', className: 'btn-secondary'}]);
        document.getElementById('modal-ok-btn').onclick = () => { modalContainer.innerHTML = ''; };
    }

    function showCustomConfirm(message, title = 'Konfirmasi') {
        return new Promise(resolve => {
            renderModal(title, message, [{id: 'modal-cancel-btn', text: 'Batal', className: 'btn-secondary'}, {id: 'modal-confirm-btn', text: 'Hapus', className: 'btn-danger'}]);
            document.getElementById('modal-confirm-btn').onclick = () => { modalContainer.innerHTML = ''; resolve(true); };
            document.getElementById('modal-cancel-btn').onclick = () => { modalContainer.innerHTML = ''; resolve(false); };
        });
    }

    function showToastNotification(message) {
        const container = document.getElementById('notification-container');
        const toast = document.createElement('div');
        toast.className = 'toast-notification';
        toast.textContent = message;
        container.appendChild(toast);
        setTimeout(() => { toast.remove(); }, 4000);
    }

    let initialFollowers = null;
    function setupNotificationListener(userId) {
        if (stopNotificationListener) stopNotificationListener();
        stopNotificationListener = db.collection("users").doc(userId).onSnapshot(doc => {
            const userData = doc.data();
            const currentFollowers = userData.followers || [];
            if (initialFollowers === null) {
                initialFollowers = new Set(currentFollowers);
                return;
            }
            const currentFollowersSet = new Set(currentFollowers);
            if (currentFollowersSet.size > initialFollowers.size) {
                for (const followerId of currentFollowersSet) {
                    if (!initialFollowers.has(followerId)) {
                        db.collection("users").doc(followerId).get().then(followerDoc => {
                            if (followerDoc.exists) {
                                showToastNotification(`${followerDoc.data().name} mulai mengikuti Anda!`);
                            }
                        });
                    }
                }
            }
            initialFollowers = currentFollowersSet;
        });
    }

    auth.onAuthStateChanged(user => {
        showLoading('Mengecek sesi...');
        if (user) {
            db.collection("users").doc(user.uid).get().then(doc => {
                if(doc.exists) {
                    const currentUserData = doc.data();
                    renderDashboard(user, currentUserData);
                    setupNotificationListener(user.uid);
                } else { auth.signOut(); }
            }).catch(err => { console.error(err); auth.signOut(); }).finally(() => hideLoading());
        } else {
            authContainer.classList.remove('hidden');
            appContainer.classList.add('hidden');
            if (stopPostsListener) stopPostsListener();
            if (stopNotificationListener) stopNotificationListener();
            initialFollowers = null;
            hideLoading();
        }
    });

    function renderDashboard(user, userData) {
        authContainer.classList.add('hidden');
        appContainer.classList.remove('hidden');
        appContainer.innerHTML = `<div id="mading-view"><div class="header"><div style="display:flex; align-items:center; gap:15px;"><div id="profile-bubble" class="profile-bubble" title="Lihat Profil Saya">${userData.name.charAt(0).toUpperCase()}</div><div><h2 style="text-align:left; margin:0;">Selamat Datang, ${userData.name}!</h2><button id="logout-btn" class="btn-danger" style="padding: 4px 8px; font-size: 12px; border-radius: 6px;">Logout</button></div></div><button id="show-post-modal-btn" class="btn">Kirim Karya Baru +</button></div><div id="mading-wall" class="mading-wall"></div></div>`;
        document.getElementById('profile-bubble').onclick = () => renderProfilePage(user.uid);
        document.getElementById('logout-btn').onclick = () => auth.signOut();
        document.getElementById('show-post-modal-btn').onclick = () => renderPostModal('create');
        fetchAndRenderPosts(userData);
    }

    async function fetchAndRenderPosts(userData) {
        if (stopPostsListener) {
            stopPostsListener();
            stopPostsListener = null;
        }
        const madingWall = document.getElementById('mading-wall');
        if (!madingWall) return;
        madingWall.innerHTML = '<p>Memuat beranda...</p>';
        
        const following = userData.following || [];

        if (following.length === 0) {
            stopPostsListener = db.collection("posts").orderBy("timestamp", "desc").onSnapshot(querySnapshot => {
                if (!document.getElementById('mading-wall')) return;
                const posts = [];
                querySnapshot.forEach(doc => posts.push({ id: doc.id, ...doc.data() }));
                
                if (posts.length === 0) {
                    madingWall.innerHTML = '<p>Belum ada karya yang dikirim. Jadilah yang pertama!</p>';
                } else {
                    renderPosts(posts);
                }
            }, error => {
                console.error("Gagal memuat beranda umum:", error);
                madingWall.innerHTML = '<p>Gagal memuat karya.</p>';
            });
            return;
        }

        try {
            const postPromises = following.map(uid => db.collection("posts").where("authorId", "==", uid).limit(5).get());
            const postSnapshots = await Promise.all(postPromises);
            let followedPosts = [];
            postSnapshots.forEach(snapshot => snapshot.forEach(doc => followedPosts.push({ id: doc.id, ...doc.data() })));
            
            followedPosts.sort((a, b) => (b.timestamp?.toDate() || 0) - (a.timestamp?.toDate() || 0));
            const topFollowedPosts = followedPosts.slice(0, 2);
            const followedPostIds = new Set(topFollowedPosts.map(p => p.id));

            const publicSnapshot = await db.collection("posts").orderBy("timestamp", "desc").limit(20).get();
            let publicPosts = [];
            publicSnapshot.forEach(doc => publicPosts.push({ id: doc.id, ...doc.data() }));

            const filteredPublicPosts = publicPosts.filter(p => !followedPostIds.has(p.id));

            madingWall.innerHTML = '';

            if (topFollowedPosts.length > 0) {
                const followedHeader = document.createElement('div');
                followedHeader.style.gridColumn = '1 / -1';
                followedHeader.innerHTML = `<h2 style="font-size: 1.5em; color: var(--primary); margin-bottom: 0;">Karya dari yang Anda ikuti</h2>`;
                madingWall.appendChild(followedHeader);
                renderPosts(topFollowedPosts, true);
            }

            const publicHeader = document.createElement('div');
            publicHeader.style.gridColumn = '1 / -1';
            publicHeader.style.marginTop = topFollowedPosts.length > 0 ? '40px' : '0';
            publicHeader.innerHTML = `<h2 style="font-size: 1.5em; color: var(--primary); margin-bottom: 0;">Jelajahi Karya Lain</h2>`;
            madingWall.appendChild(publicHeader);
            
            if (filteredPublicPosts.length > 0) {
                renderPosts(filteredPublicPosts, true);
            } else {
                madingWall.innerHTML += '<p>Tidak ada karya lain untuk dijelajahi saat ini.</p>';
            }
        } catch (error) {
            console.error("Gagal memuat beranda hibrida:", error);
            madingWall.innerHTML = `<p>Gagal memuat beranda. Coba muat ulang halaman.</p>`;
        }
    }
    
    function renderPosts(posts, append = false) {
        const madingWall = document.getElementById('mading-wall');
        if (!append) {
            madingWall.innerHTML = '';
        }
        
        if (posts.length === 0 && !append) {
            madingWall.innerHTML = '<p>Belum ada karya yang dikirim. Jadilah yang pertama!</p>';
            return;
        }

        posts.forEach(post => {
            const postId = post.id;
            const postCard = document.createElement('div');
            postCard.className = 'post-card';
            const postDate = post.timestamp ? post.timestamp.toDate().toLocaleString('id-ID', { day: 'numeric', month: 'long', year: 'numeric', hour: '2-digit', minute: '2-digit' }) : 'Baru saja';
            let menuButton = '';
            if (auth.currentUser && auth.currentUser.uid === post.authorId) {
                menuButton = `<div class="post-menu"><button class="post-menu-btn" data-menu-id="${postId}">&#8942;</button><div id="menu-${postId}" class="dropdown-menu"><a href="#" class="edit-btn" data-post-id="${postId}">Edit</a><a href="#" class="delete-btn" data-post-id="${postId}" data-author-id="${post.authorId}">Hapus</a></div></div>`;
            }
            postCard.innerHTML = `${menuButton}<h3>${post.title}</h3><p class="meta">${postDate}</p><p>${post.content}</p><p class="author">oleh: <a href="#" class="author-link" data-author-id="${post.authorId}">${post.authorName}</a></p>`;
            madingWall.appendChild(postCard);
        });
    }


    async function renderProfilePage(authorId) {
        showLoading("Memuat profil...");
        if (stopPostsListener) stopPostsListener();
        
        try {
            const currentUser = auth.currentUser;
            if (!currentUser) throw new Error("Pengguna tidak login");

            const currentUserDoc = await db.collection("users").doc(currentUser.uid).get();
            if (!currentUserDoc.exists) throw new Error("Data pengguna saat ini tidak ditemukan.");
            const currentUserData = currentUserDoc.data();

            appContainer.innerHTML = `<div id="profile-view" class="card"><button id="back-to-mading-btn" class="back-btn">← Kembali ke Mading</button><div class="profile-header"><div id="profile-pic-large" class="profile-pic-large"></div><div><div style="display:flex;align-items:center;gap:10px;justify-content:center;"><h1 id="profile-name" style="text-align:center;margin:0;"></h1><span id="verified-badge-container"></span></div><div class="profile-stats"><p><strong id="karya-count">0</strong> Karya</p><p><strong id="followers-count">0</strong> Followers</p><p><strong id="following-count">0</strong> Following</p></div></div></div><div id="follow-btn-container" style="margin-bottom:20px; text-align:center;"></div><hr><h2 style="text-align:left;font-size:1.5em;margin-top:20px;">Karya Penulis</h2><div id="profile-wall" class="mading-wall"></div></div>`;
            
            document.getElementById('back-to-mading-btn').onclick = () => {
                showLoading('Kembali...');
                renderDashboard(currentUser, currentUserData);
                hideLoading();
            };

            const userDoc = await db.collection("users").doc(authorId).get();
            if (!userDoc.exists) throw new Error("Penulis tidak ditemukan");
            const userData = userDoc.data();
            
            document.getElementById('profile-name').textContent = userData.name;
            const profilePic = document.getElementById('profile-pic-large');
            profilePic.textContent = userData.name.charAt(0).toUpperCase();
            document.getElementById('karya-count').textContent = userData.karyaCount || 0;
            document.getElementById('followers-count').textContent = (userData.followers || []).length;
            document.getElementById('following-count').textContent = (userData.following || []).length;
            
            const badgeContainer = document.getElementById('verified-badge-container');
            if (userData.karyaCount >= 10) { 
                badgeContainer.innerHTML = `<svg title="Penulis Aktif (10+ Karya)" class="verified-badge" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M6.267 3.455a3.066 3.066 0 001.745-.723 3.066 3.066 0 013.976 0 3.066 3.066 0 001.745.723 3.066 3.066 0 012.812 2.812c.051.643.304 1.254.723 1.745a3.066 3.066 0 010 3.976 3.066 3.066 0 00-.723 1.745 3.066 3.066 0 01-2.812 2.812 3.066 3.066 0 00-1.745.723 3.066 3.066 0 01-3.976 0 3.066 3.066 0 00-1.745-.723 3.066 3.066 0 01-2.812-2.812 3.066 3.066 0 00-.723-1.745 3.066 3.066 0 010-3.976 3.066 3.066 0 00.723-1.745 3.066 3.066 0 012.812-2.812zm7.44 5.252a.75.75 0 00-1.06-1.06L8.25 10.94l-1.94-1.94a.75.75 0 00-1.06 1.06L7.72 12.5l4.94-4.94a.75.75 0 00.057-.058z" clip-rule="evenodd" /></svg>`; 
            }

            if (currentUser.uid !== authorId) {
                const isFollowing = (currentUserData.following || []).includes(authorId);
                const followBtnContainer = document.getElementById('follow-btn-container');
                if (isFollowing) {
                    followBtnContainer.innerHTML = `<button id="unfollow-btn" class="btn btn-secondary" style="width:100%;">Unfollow</button>`;
                    document.getElementById('unfollow-btn').onclick = () => handleUnfollow(authorId);
                } else {
                    followBtnContainer.innerHTML = `<button id="follow-btn" class="btn" style="width:100%;">Follow</button>`;
                    document.getElementById('follow-btn').onclick = () => handleFollow(authorId);
                }
            }
            
            const postsSnapshot = await db.collection("posts").where("authorId", "==", authorId).get();
            const profileWall = document.getElementById('profile-wall');
            profileWall.innerHTML = '';

            let posts = [];
            postsSnapshot.forEach(doc => {
                posts.push(doc.data());
            });

            posts.sort((a, b) => (b.timestamp?.toDate() || 0) - (a.timestamp?.toDate() || 0));

            if (posts.length === 0) { 
                profileWall.innerHTML = '<p style="text-align:center; grid-column: 1 / -1;">Penulis ini belum mengirimkan karya.</p>'; 
            } else {
                posts.forEach(post => { 
                    const postCard = document.createElement('div'); 
                    postCard.className = 'post-card'; 
                    const postDate = post.timestamp ? post.timestamp.toDate().toLocaleString('id-ID') : ''; 
                    postCard.innerHTML = `<h3>${post.title}</h3><p class="meta">${postDate}</p><p>${post.content}</p>`; 
                    profileWall.appendChild(postCard); 
                });
            }
        
        } catch(error) {
            console.error("Error rendering profile:", error);
            appContainer.innerHTML = `<div class="card"><h2>Error</h2><p>Gagal memuat profil. Silakan coba lagi.</p><button onclick="location.reload()" class="btn">Refresh Halaman</button></div>`;
        } finally {
            hideLoading();
        }
    }
    
    appContainer.addEventListener('click', e => {
        const target = e.target;
        if (target.matches('.author-link')) { e.preventDefault(); renderProfilePage(target.dataset.authorId); }
        if (target.matches('.post-menu-btn')) {
            const allMenus = document.querySelectorAll('.dropdown-menu');
            const menu = document.getElementById(`menu-${target.dataset.menuId}`);
            allMenus.forEach(m => { if (m.id !== menu.id) m.style.display = 'none'; });
            menu.style.display = menu.style.display === 'block' ? 'none' : 'block';
        }
        if (target.matches('.edit-btn')) { e.preventDefault(); showLoading('Memuat data...'); db.collection('posts').doc(target.dataset.postId).get().then(doc => { if(doc.exists) renderPostModal('edit', doc.data(), doc.id) }).finally(()=>hideLoading()); }
        if (target.matches('.delete-btn')) { e.preventDefault(); handleDeletePost(target.dataset.postId, target.dataset.authorId); }
    });
    
    document.getElementById('register-form').addEventListener('submit', (e) => { e.preventDefault(); showLoading("Membuat akun..."); const name = document.getElementById('register-name').value; const email = document.getElementById('register-email').value; const password = document.getElementById('register-password').value; auth.createUserWithEmailAndPassword(email, password).then((cred) => { return db.collection("users").doc(cred.user.uid).set({ name: name, email: email, karyaCount: 0, followers: [], following: [] }); }).then(() => { showCustomAlert("Akun berhasil dibuat! Silakan login.", "Sukses"); document.getElementById('show-login').click(); e.target.reset(); }).catch((error) => showCustomAlert(error.message, "Error")).finally(()=>hideLoading()); });
    
    document.getElementById('login-form').addEventListener('submit', (e) => { e.preventDefault(); showLoading("Mencoba masuk..."); const email = document.getElementById('login-email').value; const password = document.getElementById('login-password').value; auth.signInWithEmailAndPassword(email, password).catch((error) => { hideLoading(); showCustomAlert(error.message, "Gagal Login"); }); });
    
    function renderPostModal(mode, postData = {}, postId = '') {
        const isEdit = mode === 'edit';
        modalContainer.innerHTML = `<div id="post-modal" class="modal"><div class="modal-content"><h2>${isEdit ? 'Edit Karya' : 'Kirim Karya Baru'}</h2><form id="post-form"><div class="form-group"><label for="post-title">Judul Karya</label><input type="text" id="post-title" value="${postData.title || ''}" required></div><div class="form-group"><label for="post-content">Isi Karya</label><textarea id="post-content" rows="8" required>${postData.content || ''}</textarea></div><div style="display:flex; gap:10px;"><button type="button" id="close-post-modal-btn" class="btn btn-secondary">Batal</button><button type="submit" class="btn" style="flex-grow:1;">${isEdit ? 'Simpan Perubahan' : 'Publikasikan'}</button></div></form></div></div>`;
        modalContainer.querySelector('#close-post-modal-btn').onclick = () => modalContainer.innerHTML = '';
        modalContainer.querySelector('#post-form').addEventListener('submit', (e) => { e.preventDefault(); if (isEdit) { handleUpdatePost(postId); } else { handleCreatePost(); } });
    }

    function handleCreatePost() { 
        showLoading("Memublikasikan..."); 
        const user = auth.currentUser; 
        db.collection("users").doc(user.uid).get().then(doc => { 
            if (doc.exists) { 
                const userData = doc.data(); 
                db.collection("posts").add({ 
                    title: document.getElementById('post-title').value, 
                    content: document.getElementById('post-content').value, 
                    authorName: userData.name, 
                    authorId: user.uid, 
                    timestamp: firebase.firestore.FieldValue.serverTimestamp() 
                }).then(() => { 
                    modalContainer.innerHTML = ''; 
                    db.collection("users").doc(user.uid).update({ karyaCount: firebase.firestore.FieldValue.increment(1) }); 
                    fetchAndRenderPosts(userData); // Refresh beranda
                }); 
            } 
        }).finally(()=>hideLoading()); 
    }

    function handleUpdatePost(postId) { 
        showLoading("Memperbarui..."); 
        db.collection("posts").doc(postId).update({ 
            title: document.getElementById('post-title').value, 
            content: document.getElementById('post-content').value 
        }).then(() => { 
            modalContainer.innerHTML = ''; 
        }).catch(err => showCustomAlert("Gagal memperbarui.", "Error")).finally(()=>hideLoading()); 
    }

    async function handleDeletePost(postId, authorId) {
        const confirmed = await showCustomConfirm("Yakin ingin menghapus karya ini?");
        if (confirmed) {
            showLoading("Menghapus...");
            const user = auth.currentUser;
            db.collection("posts").doc(postId).delete().then(() => {
                db.collection("users").doc(authorId).update({ karyaCount: firebase.firestore.FieldValue.increment(-1) });
                // PERBAIKAN: Ambil data pengguna terbaru dan refresh beranda
                db.collection("users").doc(user.uid).get().then(doc => {
                    if (doc.exists) {
                        fetchAndRenderPosts(doc.data());
                    }
                });
            }).catch(err => {
                showCustomAlert("Gagal menghapus karya.", "Error");
            }).finally(() => {
                hideLoading();
            });
        }
    }

    function handleFollow(id){ 
        showLoading("Mengikuti..."); 
        const user = auth.currentUser;
        const batch=db.batch(); 
        batch.update(db.collection('users').doc(user.uid),{following:firebase.firestore.FieldValue.arrayUnion(id)}); 
        batch.update(db.collection('users').doc(id),{followers:firebase.firestore.FieldValue.arrayUnion(user.uid)}); 
        batch.commit().then(() => {
            renderProfilePage(id);
            db.collection("users").doc(user.uid).get().then(doc => fetchAndRenderPosts(doc.data())); // Refresh beranda setelah follow
        }).catch(err=>{console.error(err); hideLoading();}); 
    }

    function handleUnfollow(id){ 
        showLoading("Batal mengikuti..."); 
        const user = auth.currentUser;
        const batch=db.batch(); 
        batch.update(db.collection('users').doc(user.uid),{following:firebase.firestore.FieldValue.arrayRemove(id)}); 
        batch.update(db.collection('users').doc(id),{followers:firebase.firestore.FieldValue.arrayRemove(user.uid)}); 
        batch.commit().then(() => {
            renderProfilePage(id);
            db.collection("users").doc(user.uid).get().then(doc => fetchAndRenderPosts(doc.data())); // Refresh beranda setelah unfollow
        }).catch(err=>{console.error(err); hideLoading();}); 
    }
</script>
</body>
</html>

